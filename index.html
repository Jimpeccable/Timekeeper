<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Day/Night Cycle Tracker</title>
    <!-- Google Fonts for fantasy aesthetic (Cinzel Decorative) and modern UI (Poppins) -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Tone.js for programmatic audio generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* --- CSS Global Reset & Base Styles --- */
        :root {
            /* Sky Colors - Define your gradient stops for different times of day */
            --sky-dawn-top: #2a0b3b; /* Deep violet */
            --sky-dawn-bottom: #8e44ad; /* Amethyst */
            --sky-morning-top: #007bff; /* Bright blue */
            --sky-morning-bottom: #52a8ff; /* Lighter blue */
            --sky-midday-top: #87ceeb; /* Sky blue */
            --sky-midday-bottom: #e0f7fa; /* Light cyan */
            --sky-dusk-top: #6a008a; /* Dark purple */
            --sky-dusk-bottom: #f5a623; /* Orange/Gold */
            --sky-night-top: #0a0b1f; /* Very dark blue/black */
            --sky-night-bottom: #1c0f4f; /* Deep indigo */

            /* Icewind Dale specific sky colors */
            --sky-icewind-day-top: #6080a0; /* Colder blue */
            --sky-icewind-day-bottom: #a0c0d0; /* Lighter icy blue */
            --sky-icewind-night-top: #050a10; /* Very dark cold blue */
            --sky-icewind-night-bottom: #101a25; /* Dark cold blue */

            /* Curse of Strahd specific sky colors */
            --sky-strahd-day-top: #202020; /* Dark grey */
            --sky-strahd-day-bottom: #404040; /* Medium grey */
            --sky-strahd-night-top: #050505; /* Almost black */
            --sky-strahd-night-bottom: #151515; /* Darker grey */


            /* Celestial Body Colors */
            --sun-color-inner: #ffe100; /* Gold */
            --sun-color-outer: #ff8c00; /* Dark orange */
            --moon-color-inner: #f0f0f0; /* Light silver */
            --moon-color-outer: #a0a0a0; /* Dark silver */

            /* UI Colors */
            --ui-bg: rgba(20, 10, 30, 0.85); /* Dark translucent background */
            --ui-border: #6d421d; /* Wood/leather brown */
            --ui-accent: #c09f52; /* Aged gold */
            --ui-text: #fff; /* White text */
            --button-hover: #e0c885; /* Lighter gold for hover */
            --button-active: #9e7f3c; /* Darker gold for active */
            --error-color: #ff4d4d; /* Red for errors */

            /* Animation Durations & Easing */
            --time-transition-duration: 3s; /* For smooth sky/light changes */
            --celestial-move-duration: 0.8s; /* For sun/moon movement updates */
            --cloud-drift-duration: 180s; /* How long for clouds to cross screen (base) */
            --star-twinkle-duration: 2s; /* Star twinkle animation speed */
            --aurora-animation-duration: 40s; /* Aurora animation speed */
            --haze-animation-duration: 5s; /* Heat haze animation speed */
            --lightning-flash-duration: 0.1s; /* Duration of lightning flash */
            --shooting-star-duration: 0.8s; /* Duration of shooting star flash */


            /* Current dynamic values (set by JS) */
            --current-sky-top: var(--sky-midday-top);
            --current-sky-bottom: var(--sky-midday-bottom);
            --sun-x-pos: 50%; /* Horizontal position of sun/moon (0% left, 100% right) */
            --sun-y-pos: 80%; /* Vertical position of sun/moon (0% top, 100% bottom/horizon) */
            --sun-glow-intensity: 1; /* Opacity/brightness of sun's glow */
            --moon-x-pos: -10%;
            --moon-y-pos: 80%;
            --moon-opacity: 0; /* Controls moon visibility */
            --stars-opacity: 0; /* Controls star field visibility */
            --aurora-opacity: 0; /* Controls aurora visibility */
            --heat-haze-opacity: 0; /* Controls heat haze visibility */
            --landscape-shadow-opacity: 0.5; /* Opacity of landscape shadow */
            --landscape-shadow-blur: 10px; /* Blur of landscape shadow */
            --landscape-shadow-offset-x: 0px; /* Horizontal offset of landscape shadow */
            --landscape-shadow-offset-y: 0px; /* Vertical offset of landscape shadow */
            --landscape-shadow-color: rgba(0, 0, 0, 0.5); /* Color of landscape shadow */
            --landscape-color: #2c3e50; /* Base landscape color */
            --landscape-filter: none; /* For weather effects on landscape */

            /* Weather effect opacities (controlled via JS, rendered on canvas) */
            --fog-opacity: 0;
            --wind-strength: 0; /* Controls wind effects like cloud speed */
            --lightning-opacity: 0; /* For lightning flash effect */
            --shooting-star-opacity: 0; /* For shooting star effect */

            /* Sleek UI Colors */
            --sleek-bg: rgba(255, 255, 255, 0.08); /* Frosted glass effect */
            --sleek-border: rgba(255, 255, 255, 0.2);
            --sleek-text: #e0e0e0;
            --sleek-accent: #87ceeb; /* Lighter blue for accents */
            --sleek-button-bg: rgba(255, 255, 255, 0.15);
            --sleek-button-hover: rgba(255, 255, 255, 0.25);
            --sleek-button-active: rgba(255, 255, 255, 0.05);
            --sleek-input-bg: rgba(0, 0, 0, 0.3);
            --sleek-input-border: rgba(255, 255, 255, 0.3);

            /* Task List Variables */
            --task-list-height: 0; /* Controlled by JS for expansion */
        }

        /* Universal box-sizing and overflow hidden for full-screen effects */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Crucial for full-screen effects without scrollbars */
            font-family: 'Poppins', sans-serif; /* Primary UI font */
            color: var(--ui-text); /* Default text color */
            -webkit-font-smoothing: antialiased; /* Smoother font rendering */
            -moz-osx-font-smoothing: grayscale;
        }

        /* Main application container */
        #app-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to top, var(--current-sky-bottom), var(--current-sky-top));
            transition: background var(--time-transition-duration) ease-in-out; /* Smooth sky color transitions */
            cursor: grab; /* Indicate draggable sky */
        }

        #app-container.dragging {
            cursor: grabbing;
        }

        /* --- Sky & Celestial Bodies Container --- */
        #sky-container {
            position: absolute; /* Allows full coverage of the top part of the app */
            width: 100%;
            height: 75%; /* Occupies top 75% of the screen */
            overflow: hidden; /* Hides celestial bodies when off-screen */
            top: 0;
            left: 0;
            z-index: 1; /* Below UI elements */
        }

        /* Base style for Sun and Moon */
        .celestial-body {
            position: absolute;
            border-radius: 50%;
            transition: transform var(--celestial-move-duration) linear,
                        opacity var(--celestial-move-duration) ease-in-out,
                        box-shadow var(--celestial-move-duration) ease-in-out;
            /* Initial positions are set by JS */
            transform: translate(-50%, -50%); /* Center the body on its calculated position */
            pointer-events: auto; /* Make them clickable/draggable */
            cursor: grab;
        }

        .celestial-body.dragging {
            cursor: grabbing;
        }

        #sun {
            width: 10vmin; /* Responsive size based on viewport */
            height: 10vmin;
            background: radial-gradient(circle at 50% 50%, var(--sun-color-inner), var(--sun-color-outer), transparent 70%);
            box-shadow: 0 0 calc(5vmin * var(--sun-glow-intensity)) calc(2vmin * var(--sun-glow-intensity)) rgba(255, 215, 0, 0.7 * var(--sun-glow-intensity));
            top: var(--sun-y-pos);
            left: var(--sun-x-pos);
            opacity: var(--sun-glow-intensity);
        }

        #moon {
            width: 8vmin;
            height: 8vmin;
            background: radial-gradient(circle at 50% 50%, var(--moon-color-inner), var(--moon-color-outer), transparent 70%);
            box-shadow: 0 0 calc(4vmin * var(--moon-opacity)) calc(1.5vmin * var(--moon-opacity)) rgba(192, 192, 192, 0.6 * var(--moon-opacity));
            top: var(--moon-y-pos);
            left: var(--moon-x-pos);
            opacity: var(--moon-opacity);
            /* Moon phases can be simulated with clip-path or multiple layers, simplified here */
        }

        /* Star field for night */
        #stars {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 1px, transparent 1px),
                        radial-gradient(circle, rgba(255,255,255,0.6) 0.8px, transparent 0.8px),
                        radial-gradient(circle, rgba(255,255,255,0.4) 0.6px, transparent 0.6px);
            background-size: 100px 100px, 150px 150px, 200px 200px; /* Density of stars */
            background-position: 0 0, 50px 50px, 100px 100px; /* Offset for more random distribution */
            opacity: var(--stars-opacity);
            transition: opacity var(--time-transition-duration) ease-in-out;
            animation: twinkle var(--star-twinkle-duration) infinite alternate ease-in-out;
            pointer-events: none; /* Allows clicks to pass through */
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.3; }
        }

        /* --- Atmospheric Effects --- */
        .clouds {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50% 50% 0 0 / 100% 100% 0 0; /* Cloud shape */
            filter: blur(8px); /* Soft blur for wispy effect */
            opacity: 0; /* Default hidden, controlled by JS */
            transition: opacity var(--time-transition-duration) ease-in-out;
            pointer-events: none;
        }

        #clouds-layer-1 {
            width: 150%; /* Wider than screen to allow continuous drift */
            height: 20%;
            top: 10%;
            animation: drift var(--cloud-drift-duration) linear infinite;
        }

        #clouds-layer-2 {
            width: 120%;
            height: 15%;
            top: 30%;
            animation: drift calc(var(--cloud-drift-duration) * 0.8) linear infinite reverse; /* Different speed/direction */
        }

        @keyframes drift {
            0% { transform: translateX(-20%); }
            100% { transform: translateX(100%); }
        }

        #aurora {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right,
                transparent,
                rgba(0, 255, 127, 0.1), /* Green */
                rgba(0, 200, 255, 0.15), /* Blue */
                rgba(150, 0, 255, 0.1), /* Purple */
                transparent
            );
            filter: blur(20px);
            opacity: var(--aurora-opacity);
            transition: opacity var(--time-transition-duration) ease-in-out;
            animation: aurora-shimmer var(--aurora-animation-duration) infinite alternate ease-in-out;
            pointer-events: none;
        }

        @keyframes aurora-shimmer {
            0%, 100% { transform: scaleY(1) translateX(0); }
            50% { transform: scaleY(1.2) translateX(10%); }
        }

        #heat-haze {
            position: absolute;
            width: 100%;
            height: 10%; /* Thin band near horizon */
            bottom: 0;
            background: rgba(255, 255, 0, 0.05);
            filter: blur(5px);
            opacity: var(--heat-haze-opacity);
            transition: opacity var(--time-transition-duration) ease-in-out;
            animation: heat-haze-shimmer var(--haze-animation-duration) infinite alternate ease-in-out;
            pointer-events: none;
        }

        @keyframes heat-haze-shimmer {
            0%, 100% { transform: translateY(0) scaleX(1); }
            50% { transform: translateY(-5px) scaleX(1.02); }
        }

        /* --- Canvas for Weather Effects --- */
        #weather-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5; /* Below celestial bodies, above sky */
            opacity: 1; /* Managed by JS for specific effects */
            transition: opacity var(--time-transition-duration) ease-in-out;
        }

        #fog-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(180, 180, 180, 0.1) 0%, rgba(180, 180, 180, 0.05) 50%, transparent 100%);
            filter: blur(15px);
            animation: fog-drift var(--fog-animation-duration) linear infinite alternate;
            opacity: var(--fog-opacity);
            pointer-events: none;
            z-index: 6; /* Above canvas particles */
        }

        @keyframes fog-drift {
            0% { transform: translateX(0) scale(1.0); }
            50% { transform: translateX(10%) scale(1.05); }
            100% { transform: translateX(0) scale(1.0); }
        }

        #lightning-flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 200, 0.8); /* Yellowish white flash */
            opacity: var(--lightning-opacity);
            transition: opacity var(--lightning-flash-duration) ease-out;
            pointer-events: none;
            z-index: 7; /* Above all other effects */
        }

        #shooting-star-effect {
            position: absolute;
            width: 20px; /* Size of the star */
            height: 20px;
            background: radial-gradient(circle at 50% 50%, #fff, rgba(255, 255, 255, 0.5), transparent 70%);
            border-radius: 50%;
            filter: blur(2px);
            opacity: var(--shooting-star-opacity);
            transition: opacity var(--shooting-star-duration) ease-out;
            pointer-events: none;
            z-index: 8; /* Above stars, below lightning */
            transform: translate(-50%, -50%); /* Center the element */
        }

        /* --- Landscape/Horizon --- */
        #landscape-container {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 30%; /* Overlaps sky-container slightly */
            background-color: var(--landscape-color); /* Base landscape color */
            z-index: 10; /* Ensure it's above sky elements */
            transition: background-color var(--time-transition-duration) ease-in-out;
            filter: var(--landscape-filter); /* Apply dynamic filters */
            overflow: hidden; /* Hide overflowing SVG parts during scroll */
        }

        #landscape-svg {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 150%; /* Make it wider than container for scrolling */
            height: 100%;
            animation: landscape-scroll linear infinite; /* Apply scrolling animation */
            transition: filter var(--time-transition-duration) ease-in-out, animation-duration 0.5s linear; /* Changed to linear for smoothness */
            transform: translateX(0); /* Initial position */
            animation-duration: 180s; /* Base duration, adjusted by JS */
            animation-play-state: running; /* Always running */
        }

        /* Removed .scrolling-active as animation-play-state is always running */
        /* #landscape-svg.scrolling-active {
            animation-play-state: running;
        } */

        .landscape-layer {
            /* These styles are mostly for fill and opacity within the SVG now */
            display: block;
            filter: drop-shadow(
                var(--landscape-shadow-offset-x)
                var(--landscape-shadow-offset-y)
                var(--landscape-shadow-blur)
                var(--landscape-shadow-color)
            );
        }

        @keyframes landscape-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-33.33%); } /* Scrolls 1/3 of the extra width */
        }


        #campfire {
            position: absolute;
            bottom: 5%; /* Adjust based on landscape height */
            left: 20%; /* Example position */
            width: 2vmin;
            height: 2vmin;
            fill: #ff8c00; /* Orange/red flame color */
            opacity: 0;
            transition: opacity 1s ease-in-out;
            animation: campfire-flicker 1s infinite alternate ease-in-out;
            z-index: 11; /* Above landscape */
            pointer-events: none;
        }

        @keyframes campfire-flicker {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }


        /* --- Time Display (more unobtrusive) --- */
        #time-display-container {
            position: absolute;
            top: 5%; /* Positioned near the top */
            left: 50%;
            transform: translateX(-50%);
            z-index: 20; /* Above sky and landscape */
            padding: 1.2vmin 2.5vmin; /* Reduced padding */
            background: var(--sleek-bg); /* Frosted glass */
            border: 1px solid var(--sleek-border); /* Subtle border */
            border-radius: 12px; /* Slightly less rounded */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3); /* Softer shadow */
            text-align: center;
            font-family: 'Cinzel Decorative', serif;
            font-size: 3.5vmin; /* Slightly smaller font */
            letter-spacing: 0.08vmin;
            color: var(--sleek-text); /* Lighter text color */
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.5); /* Softer glow */
            backdrop-filter: blur(5px); /* Frosted glass effect */
        }

        /* --- Weather Indicator (More Info & Sleek) --- */
        #weather-indicator {
            position: absolute;
            top: 5%;
            right: 5%;
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.8vmin; /* Reduced gap */
            padding: 1.8vmin; /* Slightly reduced padding */
            background: var(--sleek-bg); /* Frosted glass */
            border: 1px solid var(--sleek-border); /* Subtle border */
            border-radius: 15px; /* Slightly less rounded */
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.4); /* Softer shadow */
            font-family: 'Poppins', sans-serif;
            color: var(--sleek-text); /* Lighter text color */
            transition: all 0.5s ease-in-out;
            backdrop-filter: blur(5px); /* Frosted glass effect */
            min-width: 18vmin; /* Ensure enough space for content */
        }

        #weather-icon-display {
            position: relative;
            width: 7vmin; /* Slightly smaller icon area */
            height: 7vmin;
            margin-bottom: 0.5vmin;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #weather-icon-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            fill: var(--sleek-accent); /* Accent color for icons */
            transition: fill 0.5s ease-in-out;
        }

        .wind-line {
            position: absolute;
            background-color: var(--sleek-accent);
            height: 0.2vmin; /* Thinner wind lines */
            border-radius: 1px;
            opacity: 0;
            animation: wind-flow 2s linear infinite;
            z-index: 1; /* Above SVG icon */
        }

        @keyframes wind-flow {
            0% { transform: translateX(-100%); opacity: 0; }
            50% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }

        #weather-description {
            font-size: 2vmin; /* Smaller font */
            font-weight: 400;
            color: var(--sleek-text);
            margin-bottom: 0.3vmin;
        }

        .weather-detail {
            font-size: 1.8vmin; /* Smaller font for details */
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.2vmin;
            text-align: center;
        }

        #temperature-display {
            font-family: 'Poppins', sans-serif; /* Poppins for temp for sleek look */
            font-size: 3.2vmin; /* Smaller temp display */
            font-weight: 600;
            color: var(--sleek-accent);
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
            margin-top: 0.5vmin;
        }

        #temp-toggle-btn {
            background: var(--sleek-button-bg);
            border: 1px solid var(--sleek-border);
            border-radius: 8px; /* Slightly less rounded */
            color: var(--sleek-text);
            font-family: 'Poppins', sans-serif;
            font-size: 1.6vmin; /* Smaller font */
            padding: 0.6vmin 1vmin; /* Reduced padding */
            cursor: pointer;
            outline: none;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            box-shadow: inset 0 0 3px rgba(0, 0, 0, 0.3);
        }

        #temp-toggle-btn:hover {
            background: var(--sleek-button-hover);
            color: var(--sleek-text);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }

        /* --- Control Panel (Sleek & Minimal) --- */
        #control-panel {
            position: absolute; /* Changed to absolute */
            top: 2vmin; /* Positioned in top-left */
            left: 2vmin; /* Positioned in top-left */
            z-index: 20;
            padding: 1.5vmin; /* Reduced padding */
            background: var(--sleek-bg); /* Frosted glass */
            border: 1px solid var(--sleek-border);
            border-radius: 18px; /* Slightly less rounded */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); /* Softer shadow */
            display: flex;
            flex-direction: column;
            gap: 1vmin; /* Reduced gap for more compactness */
            align-items: center;
            transition: all 0.5s ease-in-out;
            width: 38vmin; /* Increased width by 4vmin (~40px) */
            max-height: calc(100vh - 10vmin); /* Reduced height by 6vmin (~60px) */
            overflow-y: auto; /* Enable vertical scrolling */
            padding-right: 2.5vmin; /* Add padding for scrollbar */
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }

        /* Hide scrollbar for Webkit browsers */
        #control-panel::-webkit-scrollbar {
            display: none;
        }

        .control-group {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.6vmin; /* Reduced gap */
            padding-bottom: 1vmin; /* Reduced padding to bottom of each group */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* Separator line */
            margin-bottom: 1vmin; /* Reduced margin below separator */
        }

        .control-group:last-child {
            border-bottom: none; /* No border for the last group */
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .control-group-title {
            font-family: 'Cinzel Decorative', serif;
            font-size: 2.2vmin;
            color: var(--sleek-accent);
            text-align: center;
            margin-bottom: 0.8vmin; /* Reduced margin */
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .input-row, .buttons-group {
            display: flex;
            align-items: center;
            gap: 0.8vmin; /* Reduced gap */
            font-size: 1.8vmin; /* Smaller font */
            color: var(--sleek-text); /* Lighter text color */
            text-shadow: none; /* No text shadow for minimal look */
            width: 100%;
            justify-content: center;
            flex-wrap: wrap; /* Allow wrapping for smaller screens */
        }

        #real-time-rate, .control-select, #set-day-input, #travel-time-input,
        #event-modal input[type="number"], #event-modal input[type="text"], #event-modal textarea {
            width: 8vmin; /* More compact width */
            padding: 0.8vmin 1.2vmin; /* Reduced padding */
            background: var(--sleek-input-bg); /* Darker input background */
            border: 1px solid var(--sleek-input-border); /* Subtle input border */
            border-radius: 10px; /* Slightly less rounded */
            color: var(--sleek-text);
            font-family: 'Poppins', sans-serif;
            font-size: 1.8vmin;
            text-align: center;
            outline: none;
            box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.4); /* Softer inner shadow */
            transition: border-color 0.3s, box-shadow 0.3s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23e0e0e0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); /* White custom dropdown arrow */
            background-repeat: no-repeat;
            background-position: right 0.8vmin center;
            background-size: 2vmin;
        }

        #real-time-rate:focus, .control-select:focus, #set-day-input:focus, #travel-time-input:focus,
        #event-modal input[type="number"]:focus, #event-modal input[type="text"]:focus, #event-modal textarea:focus {
            border-color: var(--sleek-accent); /* Accent color on focus */
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.6), 0 0 8px var(--sleek-accent); /* Softer glow */
        }

        .buttons-group {
            display: flex;
            gap: 1.5vmin; /* Reduced gap */
            flex-wrap: wrap; /* Allow wrapping for smaller screens */
            justify-content: center;
        }

        .control-btn {
            padding: 1.2vmin 2vmin; /* Reduced padding */
            background: var(--sleek-button-bg);
            border: 1px solid var(--sleek-border);
            border-radius: 10px; /* Slightly less rounded */
            color: var(--sleek-text);
            font-family: 'Poppins', sans-serif; /* Poppins for buttons */
            font-size: 2vmin; /* Smaller font */
            cursor: pointer;
            outline: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); /* Softer shadow */
            transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
            text-shadow: none; /* No text shadow */
            position: relative;
            overflow: hidden;
        }

        .control-btn:hover {
            background: var(--sleek-button-hover);
            transform: translateY(-1px); /* Subtle lift */
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
        }

        .control-btn:active {
            background: var(--sleek-button-active);
            transform: translateY(0);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        .control-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(0, 0, 0, 0.1);
            box-shadow: none;
        }

        /* Mute Button */
        #mute-btn {
            background: none;
            border: none;
            color: var(--sleek-text); /* Lighter text color */
            cursor: pointer;
            font-size: 2.5vmin; /* Smaller icon */
            padding: 0.6vmin;
            transition: color 0.2s, transform 0.1s;
            outline: none;
        }

        #mute-btn:hover {
            color: var(--sleek-accent); /* Accent color on hover */
            transform: scale(1.05);
        }

        #mute-btn svg {
            width: 2.5vmin;
            height: 2.5vmin;
            vertical-align: middle;
        }

        /* Message Box for alerts */
        #message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--sleek-bg);
            border: 1px solid var(--sleek-border);
            border-radius: 15px;
            padding: 3vmin;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 2vmin;
            font-family: 'Poppins', sans-serif;
            font-size: 2.5vmin;
            color: var(--sleek-text);
            text-align: center;
            backdrop-filter: blur(8px);
        }

        #message-box p {
            margin: 0;
            text-shadow: none;
        }

        #message-box button {
            padding: 1vmin 2vmin;
            background: var(--sleek-button-bg);
            border: 1px solid var(--sleek-border);
            border-radius: 8px;
            color: var(--sleek-text);
            font-family: 'Poppins', sans-serif;
            font-size: 2vmin;
            cursor: pointer;
            outline: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background 0.2s, transform 0.1s;
            text-shadow: none;
        }

        #message-box button:hover {
            background: var(--sleek-button-hover);
            transform: translateY(-1px);
        }

        /* --- Task List Panel --- */
        #task-list-toggle {
            position: fixed;
            bottom: 2vmin;
            left: 2vmin;
            z-index: 30;
            background: var(--sleek-bg);
            border: 1px solid var(--sleek-border);
            border-radius: 50%; /* Circular button by default */
            width: 6vmin;
            height: 6vmin;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, background 0.2s ease, border-radius 0.3s ease, bottom 0.3s ease, width 0.3s ease, height 0.3s ease; /* Added width/height */
            backdrop-filter: blur(5px);
        }

        #task-list-toggle:hover {
            background: var(--sleek-button-hover);
            transform: scale(1.05);
        }

        #task-list-toggle svg {
            width: 70%;
            height: 70%;
            fill: var(--sleek-text);
            transition: transform 0.3s ease; /* Smooth rotation */
        }

        /* When task list is expanded, the toggle button changes shape and position */
        #task-list-toggle.expanded {
            border-radius: 15px; /* Change to rounded rectangle when expanded */
            bottom: calc(2vmin + var(--task-list-height)); /* Position directly above panel */
            width: 40vmin; /* Match panel width */
            height: 4vmin; /* Smaller height for bar */
            left: 2vmin;
            justify-content: flex-start;
            padding-left: 1.5vmin;
        }

        #task-list-toggle.expanded span {
            display: block; /* Show text */
            margin-left: 1vmin;
            font-size: 2vmin;
            color: var(--sleek-text);
            font-family: 'Poppins', sans-serif;
            white-space: nowrap;
        }

        #task-list-toggle span {
            display: none; /* Hide text by default */
        }


        #task-list-panel {
            position: fixed;
            bottom: 2vmin;
            left: 2vmin;
            z-index: 29; /* Below toggle button */
            background: var(--sleek-bg);
            border: 1px solid var(--sleek-border);
            border-radius: 15px;
            padding: 2vmin;
            width: 40vmin; /* Fixed width for the panel */
            max-height: calc(100vh - 20vmin); /* Max height to prevent overflow */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateY(100%); /* Initially hidden below screen */
            opacity: 0;
            pointer-events: none; /* Do not block clicks when hidden */
            display: flex;
            flex-direction: column;
            gap: 1.5vmin;
            backdrop-filter: blur(5px);
            overflow-y: auto; /* Enable scrolling for tasks */
        }

        #task-list-panel.visible {
            transform: translateY(0); /* Slide up into view */
            opacity: 1;
            pointer-events: auto; /* Enable clicks when visible */
        }

        .task-input-group {
            display: flex;
            gap: 1vmin;
            width: 100%;
        }

        #new-task-input {
            flex-grow: 1;
            padding: 1vmin 1.5vmin;
            background: var(--sleek-input-bg);
            border: 1px solid var(--sleek-input-border);
            border-radius: 8px;
            color: var(--sleek-text);
            font-family: 'Poppins', sans-serif;
            font-size: 1.8vmin;
            outline: none;
        }

        #add-task-btn {
            padding: 1vmin 1.5vmin;
            background: var(--sleek-accent);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-family: 'Poppins', sans-serif;
            font-size: 1.8vmin;
            cursor: pointer;
            transition: background 0.2s;
        }

        #add-task-btn:hover {
            background: #6ab0d1; /* Slightly darker accent */
        }

        #tasks-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.8vmin;
            padding: 0;
            margin: 0;
        }

        .task-item {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            padding: 0.8vmin 1.2vmin;
            border-radius: 8px;
            font-size: 1.8vmin;
            color: var(--sleek-text);
            transition: background 0.2s;
        }

        .task-item.completed {
            text-decoration: line-through;
            color: rgba(255, 255, 255, 0.5);
            background: rgba(0, 0, 0, 0.1);
        }

        .task-item input[type="checkbox"] {
            margin-right: 1vmin;
            width: 1.8vmin;
            height: 1.8vmin;
            cursor: pointer;
            accent-color: var(--sleek-accent); /* Style checkbox */
        }

        .task-item span {
            flex-grow: 1;
        }

        .task-item .delete-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 2vmin;
            margin-left: 1vmin;
            cursor: pointer;
            transition: color 0.2s;
        }

        .task-item .delete-btn:hover {
            color: #ff4d4d; /* Red on hover */
        }


        /* --- Patreon Button --- */
        #patreon-button {
            position: fixed;
            bottom: 2vmin;
            right: 2vmin;
            z-index: 30;
            background-color: #FF424D; /* Patreon red */
            border: none;
            border-radius: 12px; /* Rounded corners */
            padding: 1.5vmin 2.5vmin;
            display: flex;
            align-items: center;
            gap: 1vmin;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            text-decoration: none; /* Remove underline for link */
        }

        #patreon-button:hover {
            background-color: #e63946; /* Slightly darker red on hover */
            transform: translateY(-2px); /* Subtle lift */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        #patreon-button:active {
            background-color: #cc333d; /* Even darker on active */
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        #patreon-button svg {
            width: 2.5vmin;
            height: 2.5vmin;
            fill: #fff; /* White heart icon */
        }

        #patreon-button span {
            color: #fff; /* White text */
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 2vmin;
            white-space: nowrap;
        }

        /* --- Event Timeline --- */
        #timeline-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5vmin; /* Height of the timeline bar */
            background: rgba(0, 0, 0, 0.2); /* Semi-transparent background */
            z-index: 25; /* Above sky, below main UI */
            overflow-x: scroll; /* Enable horizontal scrolling */
            overflow-y: hidden; /* Hide vertical scrollbar */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(3px);
            display: flex; /* Use flexbox for inner content */
            align-items: center;
            scroll-behavior: smooth; /* Smooth scrolling for JS updates */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Hide scrollbar for Webkit browsers */
        #timeline-container::-webkit-scrollbar {
            display: none;
        }

        #timeline-content {
            position: relative; /* All event markers are positioned relative to this */
            height: 100%;
            /* Width will be set dynamically by JS to cover many days */
            min-width: 100%; /* Ensure it's at least as wide as the container */
            display: flex;
            align-items: center;
        }

        /* The blue line is now fixed relative to the viewport, outside the scrolling container */
        #timeline-current-time-marker {
            position: fixed; /* Changed to fixed to be relative to viewport */
            top: 0; /* Will be adjusted by JS to align with timeline-container's top */
            left: 50%; /* Center horizontally on the screen */
            transform: translateX(-50%); /* Adjust for its own width */
            width: 2px;
            height: 5vmin; /* Match timeline-container height */
            background-color: var(--sleek-accent);
            z-index: 26; /* Higher than timeline-container */
            box-shadow: 0 0 5px var(--sleek-accent);
            pointer-events: none;
        }

        .timeline-event-marker {
            position: absolute; /* Positioned absolutely within timeline-content */
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 1;
            transition: opacity 0.2s ease; /* For dimming */
            pointer-events: auto;
            padding: 0 0.5vmin; /* Add some padding for click target */
        }

        .timeline-event-marker .icon {
            font-size: 2.5vmin;
            line-height: 1;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.7);
        }

        .timeline-event-marker .label {
            font-size: 1.2vmin;
            color: var(--sleek-text);
            white-space: nowrap;
            opacity: 0.8;
            transform: translateY(0.5vmin);
            display: none; /* Hide label by default, show on hover */
        }

        .timeline-event-marker:hover .label {
            opacity: 1;
            text-shadow: 0 0 8px var(--sleek-text);
            display: block; /* Show label on hover */
        }

        .timeline-event-marker.triggered {
            opacity: 0.4;
            pointer-events: none;
            text-decoration: line-through;
        }

        /* Timeline Increments */
        .timeline-increment-hour {
            position: absolute;
            width: 1px;
            height: 30%; /* Shorter for hours */
            background-color: rgba(255, 255, 255, 0.2); /* Faint white */
            bottom: 0;
            transform: translateX(-50%); /* Center on its X position */
            pointer-events: none;
            z-index: 0; /* Below events and marker */
        }

        .timeline-increment-day {
            position: absolute;
            width: 2px;
            height: 60%; /* Longer for days */
            background-color: rgba(255, 255, 255, 0.4); /* Slightly less faint */
            bottom: 0;
            transform: translateX(-50%); /* Center on its X position */
            pointer-index: none; /* Changed from z-index */
            z-index: 0; /* Below events and marker */
        }

        .timeline-increment-label {
            position: absolute;
            top: -1.5vmin; /* Position above the line */
            left: 50%;
            transform: translateX(-50%);
            font-size: 1vmin;
            color: rgba(255, 255, 255, 0.4); /* Faint text */
            white-space: nowrap;
            pointer-events: none;
        }

        /* Modal for Event Creation */
        #event-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--sleek-bg);
            border: 1px solid var(--sleek-border);
            border-radius: 15px;
            padding: 2.5vmin; /* Reduced padding */
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            z-index: 101; /* Above message box */
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 1.2vmin; /* Reduced gap */
            font-family: 'Poppins', sans-serif;
            color: var(--sleek-text);
            backdrop-filter: blur(8px);
            width: 45vmin; /* Slightly wider */
            max-width: 90%;
        }

        #event-modal h3 {
            margin-bottom: 0.8vmin; /* Reduced margin */
            font-size: 2.5vmin;
            color: var(--sleek-accent);
        }

        #event-modal label {
            font-size: 1.8vmin;
            width: 100%;
            text-align: left;
        }

        #event-modal .input-group-modal {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 0.5vmin;
        }

        #event-modal .input-row-modal {
            display: flex;
            align-items: center;
            gap: 1vmin;
            width: 100%;
        }

        #event-modal input[type="radio"] {
            width: auto;
            margin-right: 0.5vmin;
            accent-color: var(--sleek-accent);
        }

        #event-modal input[type="number"],
        #event-modal input[type="text"],
        #event-modal textarea,
        #event-modal select { /* Added select for styling consistency */
            width: 100%; /* Full width for text inputs and dropdowns */
            padding: 0.8vmin 1.2vmin; /* Reduced padding */
            background: var(--sleek-input-bg); /* Darker input background */
            border: 1px solid var(--sleek-input-border); /* Subtle input border */
            border-radius: 10px; /* Slightly less rounded */
            color: var(--sleek-text);
            font-family: 'Poppins', sans-serif;
            font-size: 1.8vmin;
            text-align: center;
            outline: none;
            box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.4); /* Softer inner shadow */
            transition: border-color 0.3s, box-shadow 0.3s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23e0e0e0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); /* White custom dropdown arrow */
            background-repeat: no-repeat;
            background-position: right 0.8vmin center;
            background-size: 2vmin;
        }

        #event-modal input[type="number"]:focus,
        #event-modal input[type="text"]:focus,
        #event-modal textarea:focus,
        #event-modal select:focus {
            border-color: var(--sleek-accent); /* Accent color on focus */
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.6), 0 0 8px var(--sleek-accent); /* Softer glow */
        }

        #event-modal textarea {
            min-height: 8vmin;
            resize: vertical;
        }

        #event-modal .buttons-group {
            margin-top: 1.5vmin;
            gap: 1vmin;
        }

        #event-modal button {
            padding: 1vmin 2vmin;
            background: var(--sleek-button-bg);
            border: 1px solid var(--sleek-border);
            border-radius: 8px;
            color: var(--sleek-text);
            font-family: 'Poppins', sans-serif;
            font-size: 1.8vmin;
            cursor: pointer;
            outline: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background 0.2s, transform 0.1s;
        }

        #event-modal button:hover {
            background: var(--sleek-button-hover);
            transform: translateY(-1px);
        }

        /* Event Details Modal */
        #event-details-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--sleek-bg);
            border: 1px solid var(--sleek-border);
            border-radius: 15px;
            padding: 3vmin;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            z-index: 102; /* Above event modal */
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 1.5vmin;
            font-family: 'Poppins', sans-serif;
            color: var(--sleek-text);
            backdrop-filter: blur(8px);
            width: 40vmin;
            max-width: 90%;
            text-align: center;
        }

        #event-details-modal h3 {
            margin-bottom: 1vmin;
            font-size: 2.5vmin;
            color: var(--sleek-accent);
        }

        #event-details-modal p {
            font-size: 1.8vmin;
            margin: 0.5vmin 0;
        }

        #event-details-modal .event-details-icon {
            font-size: 4vmin;
            margin-bottom: 1vmin;
        }

        #event-details-modal .buttons-group {
            margin-top: 1.5vmin;
            gap: 1vmin;
        }

        #event-details-modal button {
            padding: 1vmin 2vmin;
            background: var(--sleek-button-bg);
            border: 1px solid var(--sleek-border);
            border-radius: 8px;
            color: var(--sleek-text);
            font-family: 'Poppins', sans-serif;
            font-size: 1.8vmin;
            cursor: pointer;
            outline: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background 0.2s, transform 0.1s;
        }

        #event-details-modal button.delete-event-btn {
            background: #ff4d4d; /* Red for delete */
            border-color: #cc333d;
        }
        #event-details-modal button.delete-event-btn:hover {
            background: #e63946;
        }

        #emoji-palette span {
            background: transparent !important; /* Override hover background */
        }
        #emoji-palette span.selected-emoji {
            background: rgba(255, 255, 255, 0.2) !important; /* Highlight selected emoji */
        }


        /* --- Responsiveness --- */
        @media (max-width: 768px) {
            #time-display-container {
                font-size: 4.5vmin;
                padding: 1.5vmin 3vmin;
            }

            #weather-indicator {
                padding: 1.2vmin;
                top: 2%;
                right: 2%;
                border-radius: 12px;
                min-width: 16vmin;
            }
            #weather-icon-display {
                width: 6vmin;
                height: 6vmin;
            }
            #temperature-display {
                font-size: 2.8vmin;
            }
            #temp-toggle-btn {
                font-size: 1.5vmin;
                padding: 0.4vmin 1vmin;
            }
            #weather-description, .weather-detail {
                font-size: 1.8vmin;
            }

            /* Adjust control panel for smaller screens */
            #control-panel {
                padding: 1.2vmin;
                gap: 0.8vmin;
                max-width: 90%; /* Allow wider on mobile if needed */
                width: auto;
            }

            .input-row, .buttons-group {
                flex-direction: row; /* Keep row layout if space permits */
                font-size: 2vmin;
                gap: 0.6vmin;
                justify-content: flex-start; /* Align left */
            }

            #real-time-rate, .control-select, #set-day-input, #travel-time-input {
                width: 12vmin;
                font-size: 2vmin;
                padding: 0.6vmin 1vmin;
            }

            .buttons-group {
                flex-direction: row; /* Keep row layout if space permits */
                gap: 1vmin;
            }

            .control-btn {
                width: auto;
                font-size: 2.2vmin;
                padding: 1vmin 2vmin;
            }

            #sun {
                width: 11vmin;
                height: 11vmin;
            }

            #moon {
                width: 9vmin;
                height: 9vmin;
            }

            #mute-btn {
                font-size: 2.5vmin;
                padding: 0.3vmin;
            }
            #mute-btn svg {
                width: 2.5vmin;
                height: 2.5vmin;
            }

            /* Task List Responsiveness */
            #task-list-toggle {
                width: 7vmin;
                height: 7vmin;
            }
            #task-list-toggle.expanded {
                width: 60vmin;
                height: 5vmin;
                font-size: 2.2vmin;
            }
            #task-list-panel {
                width: 60vmin;
                padding: 1.5vmin;
                gap: 1vmin;
            }
            #new-task-input, #add-task-btn, .task-item {
                font-size: 2vmin;
            }
            .task-item input[type="checkbox"] {
                width: 2vmin;
                height: 2vmin;
            }
            .task-item .delete-btn {
                font-size: 2.2vmin;
            }

            /* Patreon Button Responsiveness */
            #patreon-button {
                padding: 1.2vmin 2vmin;
                border-radius: 10px;
            }
            #patreon-button svg {
                width: 2.2vmin;
                height: 2.2vmin;
            }
            #patreon-button span {
                font-size: 1.8vmin;
            }

            /* Event Modal Responsiveness */
            #event-modal {
                padding: 2vmin;
                gap: 1vmin;
                width: 60vmin;
            }
            #event-modal h3 {
                font-size: 2.2vmin;
            }
            #event-modal label, #event-modal input, #event-modal textarea, #event-modal button {
                font-size: 1.6vmin;
            }
            #event-details-modal {
                padding: 2vmin;
                gap: 1vmin;
                width: 60vmin;
            }
            #event-details-modal h3, #event-details-modal p {
                font-size: 1.8vmin;
            }
            #event-details-modal .event-details-icon {
                font-size: 3.5vmin;
            }
        }

        @media (max-width: 480px) {
            #time-display-container {
                font-size: 5vmin;
                padding: 1.8vmin 3.5vmin;
            }

            #weather-indicator {
                padding: 1vmin;
                top: 1%;
                right: 1%;
                border-radius: 10px;
                min-width: 14vmin;
            }
            #weather-icon-display {
                width: 5vmin;
                height: 5vmin;
            }
            #temperature-display {
                font-size: 2.2vmin;
            }
            #temp-toggle-btn {
                font-size: 1.4vmin;
                padding: 0.3vmin 0.8vmin;
            }
            #weather-description, .weather-detail {
                font-size: 1.6vmin;
            }

            /* Further adjust control panel for very small screens */
            #control-panel {
                padding: 1vmin;
                gap: 0.6vmin;
                max-width: 95%;
            }

            .input-row, .buttons-group {
                flex-direction: column; /* Stack elements vertically */
                font-size: 2.2vmin;
                gap: 0.5vmin;
                align-items: flex-start; /* Align text to the left */
            }

            #real-time-rate, .control-select, #set-day-input, #travel-time-input {
                width: 15vmin;
                font-size: 2.2vmin;
            }

            .buttons-group {
                flex-direction: column; /* Stack buttons vertically */
                gap: 0.8vmin;
            }

            .control-btn {
                width: 20vmin; /* Make buttons wider */
                font-size: 2.5vmin;
                padding: 1.2vmin 2.5vmin;
            }

            #mute-btn {
                font-size: 2.2vmin;
                padding: 0.2vmin;
            }
            #mute-btn svg {
                width: 2.2vmin;
                height: 2.2vmin;
            }

            /* Task List Responsiveness */
            #task-list-toggle {
                width: 8vmin;
                height: 8vmin;
            }
            #task-list-toggle.expanded {
                width: 80vmin;
                height: 6vmin;
                font-size: 2.5vmin;
            }
            #task-list-panel {
                width: 80vmin;
                padding: 1.2vmin;
                gap: 0.8vmin;
            }
            #new-task-input, #add-task-btn, .task-item {
                font-size: 2.2vmin;
            }
            .task-item input[type="checkbox"] {
                width: 2.2vmin;
                height: 2.2vmin;
            }
            .task-item .delete-btn {
                font-size: 2.5vmin;
            }

            /* Patreon Button Responsiveness */
            #patreon-button {
                padding: 1vmin 1.8vmin;
                border-radius: 8px;
            }
            #patreon-button svg {
                width: 2vmin;
                height: 2vmin;
            }
            #patreon-button span {
                font-size: 1.6vmin;
            }

            /* Event Modal Responsiveness */
            #event-modal {
                padding: 1.5vmin;
                gap: 1vmin;
                width: 80vmin;
            }
            #event-modal h3 {
                font-size: 2.5vmin;
            }
            #event-modal label, #event-modal input, #event-modal textarea, #event-modal button {
                font-size: 1.8vmin;
            }
            #event-details-modal {
                padding: 1.5vmin;
                gap: 1vmin;
                width: 80vmin;
            }
            #event-details-modal h3, #event-details-modal p {
                font-size: 2vmin;
            }
            #event-details-modal .event-details-icon {
                font-size: 4vmin;
            }
        }

    </style>
</head>
<body>
    <div id="app-container">
        <!-- Event Timeline -->
        <div id="timeline-container">
            <div id="timeline-content">
                <!-- Event markers and increments will be dynamically added here -->
            </div>
        </div>
        <!-- The blue line is now outside the scrolling container to keep it fixed -->
        <div id="timeline-current-time-marker"></div>

        <div id="sky-container">
            <!-- Celestial Bodies -->
            <div id="sun" class="celestial-body"></div>
            <div id="moon" class="celestial-body"></div>
            <!-- Stars (visible at night) -->
            <div id="stars"></div>
            <!-- Clouds (multiple layers for depth) -->
            <div id="clouds-layer-1" class="clouds"></div>
            <div id="clouds-layer-2" class="clouds"></div>
            <!-- Atmospheric Effects (Aurora for deep night, Heat Haze for midday) -->
            <div id="aurora"></div>
            <div id="heat-haze"></div>
            <!-- Canvas for particle-based weather effects (rain, snow) -->
            <canvas id="weather-canvas"></canvas>
            <!-- Fog effect (CSS-based for blur) -->
            <div id="fog-effect" class="weather-effect"></div>
            <div id="lightning-flash"></div> <!-- For lightning events -->
            <div id="shooting-star-effect"></div> <!-- For shooting star event -->
        </div>

        <!-- Stylized Landscape/Horizon (SVG will be injected here) -->
        <div id="landscape-container">
            <!-- SVG for landscape silhouette will be dynamically added here by JS -->
            <svg id="landscape-svg" viewBox="0 0 1000 500" preserveAspectRatio="xMidYMax slice">
                <defs>
                    <linearGradient id="landscapeGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stop-color="var(--landscape-color)"/>
                        <stop offset="100%" stop-color="rgba(0,0,0,0.5)"/>
                    </linearGradient>
                    <filter id="snowOverlay">
                        <feColorMatrix type="matrix" values="0 0 0 0 1
                                                             0 0 0 0 1
                                                             0 0 0 0 1
                                                             0 0 0 0.5 0" />
                        <feComponentTransfer>
                            <feFuncA type="linear" slope="0.5" intercept="0.5"/>
                        </feComponentTransfer>
                        <feBlend in="SourceGraphic" in2="SourceAlpha" mode="normal"/>
                    </filter>
                </defs>
                <!-- These paths will be dynamically updated by JS based on biome -->
                <path class="landscape-layer" id="mountain-layer-1" fill="url(#landscapeGradient)" d="M0 500 L0 300 C 100 200, 250 150, 400 250 S 600 300, 750 200 S 900 100, 1000 250 L1000 500 Z" opacity="0.8"/>
                <path class="landscape-layer" id="mountain-layer-2" fill="url(#landscapeGradient)" d="M0 500 L0 350 C 120 280, 300 220, 500 350 S 750 400, 1000 300 L1000 500 Z" opacity="0.9"/>
                <path class="landscape-layer" id="foreground-layer" fill="url(#landscapeGradient)" d="M0 500 L0 400 C 150 350, 350 320, 600 400 S 850 450, 1000 350 L1000 500 Z" opacity="1"/>
                <path class="landscape-layer" id="river-path" fill="#4a90e2" opacity="0.6" d="M100 480 Q 250 430, 400 480 T 700 430 T 900 480 L900 500 L100 500 Z" />
                <path class="landscape-layer" id="city-silhouette" fill="#3a3a3a" opacity="0.7" d="M400 380 L400 320 Q405 315, 410 320 L410 340 Q415 335, 420 340 L420 320 Q425 315, 430 320 L430 380 Z M440 380 L440 300 Q445 295, 450 300 L450 320 Q455 315, 460 320 L460 300 Q465 295, 470 300 L470 380 Z M480 380 L480 340 Q485 335, 490 340 L490 360 Q495 355, 500 360 L500 340 Q505 335, 510 340 L510 380 Z M520 380 L520 310 Q525 305, 530 310 L530 330 Q535 325, 540 330 L540 310 Q545 305, 550 310 L550 380 Z" />
                <path class="landscape-layer" id="forest-silhouette" fill="#228B22" opacity="0.8" d="M10 420 C 12 400, 18 390, 25 400 C 32 390, 38 400, 40 420 Z M50 430 C 52 410, 58 400, 65 410 C 72 400, 78 410, 80 430 Z M90 410 C 92 390, 98 380, 105 390 C 112 380, 118 390, 120 410 Z M130 440 C 132 420, 138 410, 145 420 C 152 410, 158 420, 160 440 Z M170 425 C 172 405, 178 395, 185 405 C 192 395, 198 405, 200 425 Z M210 400 C 212 380, 218 370, 225 380 C 232 370, 238 380, 240 400 Z M250 435 C 252 415, 258 405, 265 415 C 272 405, 278 415, 280 435 Z M290 415 C 292 395, 298 385, 305 395 C 312 385, 318 395, 320 415 Z" />
                <path class="landscape-layer" id="castle-silhouette" fill="url(#landscapeGradient)" d="M700 350 L700 250 C705 240, 715 240, 720 250 L720 280 C725 270, 735 270, 740 280 L740 350 Z M750 350 L750 220 C755 210, 765 210, 770 220 L770 240 C775 230, 785 230, 790 240 L790 350 Z M800 350 L800 300 C805 290, 815 290, 820 300 L820 320 C825 310, 835 310, 840 320 L840 350 Z" />
            </svg>
        </div>

        <!-- Prominent Time Display -->
        <div id="time-display-container">
            <h1 id="in-game-time">Day 1, 06:00 AM</h1>
        </div>

        <!-- Weather Indicator -->
        <div id="weather-indicator">
            <div id="weather-icon-display">
                <svg id="weather-icon-svg" viewBox="0 0 24 24">
                    <!-- Default Sun Icon -->
                    <path d="M12 2.5c-5.25 0-9.5 4.25-9.5 9.5s4.25 9.5 9.5 9.5 9.5-4.25 9.5-9.5-4.25-9.5-9.5-9.5zm-.08 17.5c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zM12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6z"/>
                </svg>
                <!-- Wind lines will be dynamically added here by JS -->
            </div>
            <span id="weather-description">Clear Sky</span>
            <span id="temperature-display">15°C</span>
            <span id="wind-direction-display" class="weather-detail">Wind: N/A</span>
            <span id="visibility-display" class="weather-detail">Visibility: Good</span>
            <button id="temp-toggle-btn">°F</button>
        </div>

        <!-- Control Panel -->
        <div id="control-panel">
            <div class="control-group">
                <h4 class="control-group-title">Time Controls</h4>
                <div class="input-row">
                    <label for="in-game-unit">1 In-Game</label>
                    <select id="in-game-unit" class="control-select">
                        <option value="minute">Minute</option>
                        <option value="hour">Hour</option>
                        <option value="day">Day</option>
                    </select>
                    <span>=</span>
                    <input type="number" id="real-time-rate" value="1" min="0.1" step="0.1">
                    <span id="real-time-unit-label">Real-World Seconds</span>
                </div>
                <div class="buttons-group">
                    <button id="start-btn" class="control-btn">Start</button>
                    <button id="pause-btn" class="control-btn disabled" disabled>Pause</button>
                    <button id="reset-btn" class="control-btn">Reset</button>
                </div>
            </div>

            <div class="control-group">
                <h4 class="control-group-title">Environment</h4>
                <div class="input-row">
                    <label for="campaign-theme">Campaign Theme:</label>
                    <select id="campaign-theme" class="control-select">
                        <option value="standard">Standard</option>
                        <option value="icewind-dale">Icewind Dale (Snowy)</option>
                        <option value="curse-of-strahd">Curse of Strahd (Dire)</option>
                    </select>
                </div>
                <div class="input-row">
                    <label for="biome-select">Biome:</label>
                    <select id="biome-select" class="control-select">
                        <option value="forest">Forest</option>
                        <option value="desert">Desert</option>
                        <option value="mountains">Mountains</option>
                        <option value="city">City</option>
                        <option value="dungeon">Dungeon</option>
                        <option value="arctic">Arctic</option>
                        <option value="coast">Coast</option>
                    </select>
                </div>
                <div class="input-row">
                    <label for="manual-weather">Choose Weather:</label>
                    <select id="manual-weather" class="control-select">
                        <!-- Options will be dynamically populated by JS -->
                    </select>
                </div>
            </div>

            <div class="control-group">
                <h4 class="control-group-title">Party Actions</h4>
                <div class="input-row">
                    <label for="set-day-input">Move Day:</label>
                    <input type="number" id="set-day-input" value="1" min="1">
                    <button id="set-day-btn" class="control-btn">Move</button>
                </div>
                <div class="buttons-group">
                    <button id="short-rest-btn" class="control-btn">Short Rest (1h)</button>
                    <button id="long-rest-btn" class="control-btn">Long Rest (8h)</button>
                </div>
                <div class="input-row">
                    <label for="travel-time-input">Travel:</label>
                    <input type="number" id="travel-time-input" value="1" min="1">
                    <select id="travel-unit-select" class="control-select">
                        <option value="hour">Hour(s)</option>
                        <option value="day">Day(s)</option>
                    </select>
                    <button id="travel-btn" class="control-btn">Go</button>
                </div>
            </div>

            <div class="control-group">
                <h4 class="control-group-title">Events & Audio</h4>
                <div class="buttons-group">
                    <button id="add-event-btn" class="control-btn">Schedule Event</button>
                    <button id="mute-btn" aria-label="Mute/Unmute Audio">
                        <svg id="volume-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Message Box (instead of alert/confirm) -->
    <div id="message-box">
        <p id="message-text"></p>
        <button id="message-ok-btn">OK</button>
    </div>

    <!-- Event Scheduling Modal -->
    <div id="event-modal">
        <h3>Schedule New Event</h3>
        <div class="input-group-modal">
            <label>When would you like to schedule the event?</label>
            <div class="input-row-modal">
                <input type="radio" id="schedule-on-day" name="schedule-type" value="on-day" checked>
                <label for="schedule-on-day">On Day:</label>
                <input type="number" id="event-day" min="1" value="1">
            </div>
            <div class="input-row-modal">
                <input type="radio" id="schedule-in-days" name="schedule-type" value="in-days">
                <label for="schedule-in-days">In</label>
                <input type="number" id="event-in-days" min="0" value="0">
                <span>Day(s) from now</span>
            </div>
            <div class="input-row-modal">
                <input type="radio" id="schedule-in-weeks" name="schedule-type" value="in-weeks">
                <label for="schedule-in-weeks">In</label>
                <input type="number" id="event-in-weeks" min="0" value="0">
                <span>Week(s) from now</span>
            </div>
        </div>

        <div class="input-group-modal">
            <label for="event-hour">Time (HH:MM):</label>
            <div class="input-row-modal">
                <select id="event-hour"></select>
                <span>:</span>
                <select id="event-minute"></select>
            </div>
        </div>

        <div class="input-group-modal">
            <label for="event-message">Message:</label>
            <textarea id="event-message" placeholder="e.g., 'NPC arrives', 'Monster attack'"></textarea>
        </div>

        <div class="input-group-modal">
            <label for="event-icon">Icon/Emoji:</label>
            <input type="text" id="event-icon" placeholder="Choose from allowed emojis">
            <div id="emoji-palette" style="display: flex; flex-wrap: wrap; gap: 0.5vmin; margin-top: 1vmin; max-height: 10vmin; overflow-y: auto;">
                <!-- Emojis will be dynamically added here -->
            </div>
        </div>

        <div class="buttons-group">
            <button id="save-event-btn">Save Event</button>
            <button id="cancel-event-btn">Cancel</button>
        </div>
    </div>

    <!-- Event Details Modal -->
    <div id="event-details-modal">
        <h3>Event Details</h3>
        <p class="event-details-icon" id="detail-event-icon"></p>
        <p><strong>Day:</strong> <span id="detail-event-day"></span></p>
        <p><strong>Time:</strong> <span id="detail-event-time"></span></p>
        <p><strong>Message:</strong> <span id="detail-event-message"></span></p>
        <div class="buttons-group">
            <button id="delete-event-btn" class="delete-event-btn">Delete Event</button>
            <button id="close-details-btn">Close</button>
        </div>
    </div>

    <!-- Task List Toggle Button -->
    <div id="task-list-toggle">
        <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 14l5-5 5 5z"/>
        </svg>
        <span>Tasks</span>
    </div>

    <!-- Task List Panel -->
    <div id="task-list-panel">
        <div class="task-input-group">
            <input type="text" id="new-task-input" placeholder="Add a new task...">
            <button id="add-task-btn">Add</button>
        </div>
        <ul id="tasks-list">
            <!-- Task items will be added here by JS -->
        </ul>
    </div>

    <!-- Patreon Button -->
    <a href="https://www.patreon.com/jimpeccable" target="_blank" rel="noopener noreferrer" id="patreon-button">
        <svg viewBox="0 0 24 24">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
        </svg>
        <span>SUPPORT ON PATREON</span>
    </a>

    <script>
        // --- JavaScript Global Variables ---
        let inGameTimeMinutes = 0; // Total in-game minutes from Day 1, 00:00
        let realTimeRateSecondsPerUnit = 1; // Real-world seconds per selected in-game unit
        let inGameTimeUnit = 'minute'; // 'minute', 'hour', or 'day'
        let timerInterval = null; // Stores the setInterval ID
        let isRunning = false; // Flag to track if the timer is running
        let currentCampaignTheme = 'standard'; // 'standard', 'icewind-dale', 'curse-of-strahd'
        let currentBiome = 'forest'; // New: Current biome

        // Weather state variables
        let currentWeather = 'clear'; // 'clear', 'rainy', 'snowy', 'foggy', 'windy', 'blizzard'
        let weatherDurationMinutes = 120; // How long current weather lasts (in in-game minutes)
        let nextWeatherChangeTime = weatherDurationMinutes; // When to change weather next
        let currentTemperatureC = 15; // Default temperature in Celsius
        let displayFahrenheit = false; // Flag for temperature display unit
        let manualWeatherSelection = ''; // Stores manually selected weather, if any

        // Dragging state for celestial bodies
        let isDraggingSun = false;
        let isDraggingMoon = false;
        let dragStartX = 0;
        let initialInGameTimeMinutes = 0;

        // Audio state
        let isMuted = false;
        let audioContextInitialized = false; // To handle user gesture requirement for audio

        // Task list state
        let isTaskListExpanded = false;

        // Event scheduler state
        let scheduledEvents = []; // Array to store scheduled events: [{id, day, hour, minute, message, icon, triggered}]
        let nextEventId = 0; // For unique event IDs
        let currentEventDetailsId = null; // To store the ID of the event currently displayed in details modal

        // --- DOM Element References ---
        const inGameTimeDisplay = document.getElementById('in-game-time');
        const inGameUnitSelect = document.getElementById('in-game-unit');
        const realTimeRateInput = document.getElementById('real-time-rate');
        const realTimeUnitLabel = document.getElementById('real-time-unit-label');
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const appContainer = document.getElementById('app-container');
        const skyContainer = document.getElementById('sky-container');
        const sunElement = document.getElementById('sun');
        const moonElement = document.getElementById('moon');
        const starsElement = document.getElementById('stars');
        const cloudsLayer1 = document.getElementById('clouds-layer-1');
        const cloudsLayer2 = document.getElementById('clouds-layer-2');
        const auroraElement = document.getElementById('aurora');
        const heatHazeElement = document.getElementById('heat-haze');
        const landscapeContainer = document.getElementById('landscape-container');
        const campfireElement = document.getElementById('campfire'); // Campfire element
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageOkBtn = document.getElementById('message-ok-btn');
        const campaignThemeSelect = document.getElementById('campaign-theme');
        const fogEffect = document.getElementById('fog-effect');
        const lightningFlash = document.getElementById('lightning-flash');
        const shootingStarEffect = document.getElementById('shooting-star-effect'); // New shooting star element
        const weatherCanvas = document.getElementById('weather-canvas');
        const ctx = weatherCanvas.getContext('2d');
        const muteBtn = document.getElementById('mute-btn');
        const volumeIcon = document.getElementById('volume-icon');
        const weatherIconSvg = document.getElementById('weather-icon-svg');
        const weatherIconDisplay = document.getElementById('weather-icon-display'); // New container for icon and wind lines
        const weatherDescription = document.getElementById('weather-description'); // New weather description element
        const temperatureDisplay = document.getElementById('temperature-display');
        const tempToggleButton = document.getElementById('temp-toggle-btn');
        const manualWeatherSelect = document.getElementById('manual-weather');
        const windDirectionDisplay = document.getElementById('wind-direction-display');
        const visibilityDisplay = document.getElementById('visibility-display');
        const landscapeSVG = document.getElementById('landscape-svg'); // Reference to the SVG element
        const taskListToggleButton = document.getElementById('task-list-toggle');
        const taskListToggleSvg = taskListToggleButton.querySelector('svg'); // Get the SVG inside the toggle
        const taskListPanel = document.getElementById('task-list-panel');
        const newTaskInput = document.getElementById('new-task-input');
        const addTaskBtn = document.getElementById('add-task-btn');
        const tasksList = document.getElementById('tasks-list');
        const biomeSelect = document.getElementById('biome-select'); // New: Biome select
        const shortRestBtn = document.getElementById('short-rest-btn'); // New: Short Rest button
        const longRestBtn = document.getElementById('long-rest-btn'); // New: Long Rest button
        const travelTimeInput = document.getElementById('travel-time-input'); // New: Travel input
        const travelUnitSelect = document.getElementById('travel-unit-select'); // New: Travel unit select
        const travelBtn = document.getElementById('travel-btn'); // New: Travel button
        const setDayInput = document.getElementById('set-day-input'); // New: Set Day input
        const setDayBtn = document.getElementById('set-day-btn'); // New: Set Day button
        const addEventBtn = document.getElementById('add-event-btn'); // New: Add Event button
        const eventModal = document.getElementById('event-modal'); // New: Event modal
        const eventDayInput = document.getElementById('event-day'); // New: Event day input (specific day)
        const eventInDaysInput = document.getElementById('event-in-days'); // New: Event in X days
        const eventInWeeksInput = document.getElementById('event-in-weeks'); // New: Event in X weeks
        const scheduleOnDayRadio = document.getElementById('schedule-on-day');
        const scheduleInDaysRadio = document.getElementById('schedule-in-days');
        const scheduleInWeeksRadio = document.getElementById('schedule-in-weeks');
        const eventHourSelect = document.getElementById('event-hour'); // Changed to select
        const eventMinuteSelect = document.getElementById('event-minute'); // Changed to select
        const eventMessageInput = document.getElementById('event-message'); // New: Event message input
        const eventIconInput = document.getElementById('event-icon'); // New: Event icon input
        const saveEventBtn = document.getElementById('save-event-btn'); // New: Save event button
        const cancelEventBtn = document.getElementById('cancel-event-btn'); // New: Cancel event button
        const timelineContainer = document.getElementById('timeline-container'); // New: Timeline container
        const timelineContent = document.getElementById('timeline-content'); // New: Timeline content wrapper
        const timelineCurrentTimeMarker = document.getElementById('timeline-current-time-marker'); // New: Timeline current time marker

        const emojiPalette = document.getElementById('emoji-palette'); // New: Emoji palette

        const eventDetailsModal = document.getElementById('event-details-modal'); // New: Event details modal
        const detailEventIcon = document.getElementById('detail-event-icon');
        const detailEventDay = document.getElementById('detail-event-day');
        const detailEventTime = document.getElementById('detail-event-time');
        const detailEventMessage = document.getElementById('detail-event-message');
        const deleteEventBtn = document.getElementById('delete-event-btn');
        const closeDetailsBtn = document.getElementById('close-details-btn');


        // Landscape SVG Paths
        const landscapeLayers = {
            'mountain-layer-1': document.getElementById('mountain-layer-1'),
            'mountain-layer-2': document.getElementById('mountain-layer-2'),
            'foreground-layer': document.getElementById('foreground-layer'),
            'river-path': document.getElementById('river-path'),
            'city-silhouette': document.getElementById('city-silhouette'),
            'forest-silhouette': document.getElementById('forest-silhouette'),
            'castle-silhouette': document.getElementById('castle-silhouette')
        };


        // --- Constants for Time & Visuals ---
        const MINUTES_IN_HOUR = 60;
        const HOURS_IN_DAY = 24;
        const MINUTES_IN_DAY = MINUTES_IN_HOUR * HOURS_IN_DAY;
        const DAYS_IN_WEEK = 7;

        // Pixels per minute for timeline rendering. This determines the "zoom" of the timeline.
        // Increased slightly to make movement more obvious.
        const PIXELS_PER_MINUTE = 3;

        // Define a very large conceptual timeline to ensure smooth scrolling
        const CONCEPTUAL_TIMELINE_DAYS = 365 * 10; // 10 years worth of timeline content

        // Sky color definitions for smooth interpolation
        const SKY_TRANSITIONS = {
            'standard': [
                { startHour: 4, endHour: 6, topStart: getCssVar('--sky-night-top'), bottomStart: getCssVar('--sky-night-bottom'), topEnd: getCssVar('--sky-dawn-top'), bottomEnd: getCssVar('--sky-dawn-bottom') },
                { startHour: 6, endHour: 8, topStart: getCssVar('--sky-dawn-top'), bottomStart: getCssVar('--sky-dawn-bottom'), topEnd: getCssVar('--sky-morning-top'), bottomEnd: getCssVar('--sky-morning-bottom') },
                { startHour: 8, endHour: 10, topStart: getCssVar('--sky-morning-top'), bottomStart: getCssVar('--sky-morning-bottom'), topEnd: getCssVar('--sky-midday-top'), bottomEnd: getCssVar('--sky-midday-bottom') },
                { startHour: 16, endHour: 18, topStart: getCssVar('--sky-midday-top'), bottomStart: getCssVar('--sky-midday-bottom'), topEnd: getCssVar('--sky-dusk-top'), bottomEnd: getCssVar('--sky-dusk-bottom') },
                { startHour: 18, endHour: 20, topStart: getCssVar('--sky-dusk-top'), bottomStart: getCssVar('--sky-dusk-bottom'), topEnd: getCssVar('--sky-night-top'), bottomEnd: getCssVar('--sky-night-bottom') },
                { startHour: 20, endHour: 24, topStart: getCssVar('--sky-night-top'), bottomStart: getCssVar('--sky-night-bottom'), topEnd: getCssVar('--sky-night-top'), bottomEnd: getCssVar('--sky-night-bottom') },
                { startHour: 0, endHour: 4, topStart: getCssVar('--sky-night-top'), bottomStart: getCssVar('--sky-night-bottom'), topEnd: getCssVar('--sky-night-top'), bottomEnd: getCssVar('--sky-night-bottom') },
            ],
            'icewind-dale': [
                { startHour: 4, endHour: 8, topStart: getCssVar('--sky-icewind-night-top'), bottomStart: getCssVar('--sky-icewind-night-bottom'), topEnd: getCssVar('--sky-icewind-day-top'), bottomEnd: getCssVar('--sky-icewind-day-bottom') },
                { startHour: 8, endHour: 18, topStart: getCssVar('--sky-icewind-day-top'), bottomStart: getCssVar('--sky-icewind-day-bottom'), topEnd: getCssVar('--sky-icewind-day-top'), bottomEnd: getCssVar('--sky-icewind-day-bottom') },
                { startHour: 18, endHour: 22, topStart: getCssVar('--sky-icewind-day-top'), bottomStart: getCssVar('--sky-icewind-day-bottom'), topEnd: getCssVar('--sky-icewind-night-top'), bottomEnd: getCssVar('--sky-icewind-night-bottom') },
                { startHour: 22, endHour: 24, topStart: getCssVar('--sky-icewind-night-top'), bottomStart: getCssVar('--sky-icewind-night-bottom'), topEnd: getCssVar('--sky-icewind-night-top'), bottomEnd: getCssVar('--sky-icewind-night-bottom') },
                { startHour: 0, endHour: 4, topStart: getCssVar('--sky-icewind-night-top'), bottomStart: getCssVar('--sky-icewind-night-bottom'), topEnd: getCssVar('--sky-icewind-night-top'), bottomEnd: getCssVar('--sky-icewind-night-bottom') },
            ],
            'curse-of-strahd': [
                { startHour: 4, endHour: 8, topStart: getCssVar('--sky-strahd-night-top'), bottomStart: getCssVar('--sky-strahd-night-bottom'), topEnd: getCssVar('--sky-strahd-day-top'), bottomEnd: getCssVar('--sky-strahd-day-bottom') },
                { startHour: 8, endHour: 18, topStart: getCssVar('--sky-strahd-day-top'), bottomStart: getCssVar('--sky-strahd-day-bottom'), topEnd: getCssVar('--sky-strahd-day-top'), bottomEnd: getCssVar('--sky-strahd-day-bottom') },
                { startHour: 18, endHour: 22, topStart: getCssVar('--sky-strahd-day-top'), bottomStart: getCssVar('--sky-strahd-day-bottom'), topEnd: getCssVar('--sky-strahd-night-top'), bottomEnd: getCssVar('--sky-strahd-night-bottom') },
                { startHour: 22, endHour: 24, topStart: getCssVar('--sky-strahd-night-top'), bottomStart: getCssVar('--sky-strahd-night-bottom'), topEnd: getCssVar('--sky-strahd-night-top'), bottomEnd: getCssVar('--sky-strahd-night-bottom') },
                { startHour: 0, endHour: 4, topStart: getCssVar('--sky-strahd-night-top'), bottomStart: getCssVar('--sky-strahd-night-bottom'), topEnd: getCssVar('--sky-strahd-night-top'), bottomEnd: getCssVar('--sky-strahd-night-bottom') },
            ]
        };

        // Weather types and their typical durations (in in-game minutes)
        const WEATHER_TYPES = {
            'standard': {
                'clear': { minDuration: 180, maxDuration: 360, particleColor: null, particleSpeed: 0, particleDensity: 0, windEffect: 0.1, tempC: [10, 20], description: 'Clear Sky', visibility: 'Good' },
                'cloudy': { minDuration: 120, maxDuration: 240, particleColor: null, particleSpeed: 0, particleDensity: 0, windEffect: 0.3, tempC: [5, 15], description: 'Cloudy', visibility: 'Normal' },
                'rainy': { minDuration: 60, maxDuration: 180, particleColor: 'rgba(173, 216, 230, 0.6)', particleSpeed: 10, particleDensity: 150, windEffect: 0.7, tempC: [2, 10], description: 'Rainy', visibility: 'Reduced' },
                'windy': { minDuration: 90, maxDuration: 210, particleColor: null, particleSpeed: 0, particleDensity: 0, windEffect: 1.2, tempC: [8, 18], description: 'Windy', visibility: 'Normal' }
            },
            'icewind-dale': {
                'snowy': { minDuration: 240, maxDuration: 720, particleColor: 'rgba(255, 255, 255, 0.8)', particleSpeed: 3, particleDensity: 100, windEffect: 0.5, tempC: [-20, -5], description: 'Snowy', visibility: 'Reduced', landscapeFilter: 'saturate(0.2) brightness(1.5)' },
                'blizzard': { minDuration: 60, maxDuration: 180, particleColor: 'rgba(255, 255, 255, 1.0)', particleSpeed: 6, particleDensity: 200, windEffect: 1.5, tempC: [-30, -10], description: 'Blizzard', visibility: 'Very Low', landscapeFilter: 'saturate(0.2) brightness(1.5)' }
            },
            'curse-of-strahd': {
                'foggy': { minDuration: 180, maxDuration: 480, particleColor: null, particleSpeed: 0, particleDensity: 0, windEffect: 0.2, tempC: [0, 8], description: 'Dense Fog', visibility: 'Very Low', landscapeFilter: 'saturate(0.3) contrast(1.2) brightness(0.8) brightness(0.9)' }, // Fog is CSS based
                'rainy': { minDuration: 90, maxDuration: 240, particleColor: 'rgba(100, 100, 100, 0.7)', particleSpeed: 12, particleDensity: 180, windEffect: 0.8, tempC: [-5, 5], description: 'Gloomy Rain', visibility: 'Low', landscapeFilter: 'saturate(0.3) contrast(1.2) brightness(0.8) brightness(0.8) contrast(1.1)' }, // Darker rain
                'cloudy': { minDuration: 120, maxDuration: 300, particleColor: null, particleSpeed: 0, particleDensity: 0, windEffect: 0.4, tempC: [3, 12], description: 'Overcast', visibility: 'Normal', landscapeFilter: 'saturate(0.3) contrast(1.2) brightness(0.8)' }
            }
        };

        // Biome-specific data including landscape SVG paths and weather types
        const BIOMES = {
            'forest': {
                landscape: {
                    'mountain-layer-1': "M0 500 L0 300 C 100 200, 250 150, 400 250 S 600 300, 750 200 S 900 100, 1000 250 L1000 500 Z",
                    'mountain-layer-2': "M0 500 L0 350 C 120 280, 300 220, 500 350 S 750 400, 1000 300 L1000 500 Z",
                    'foreground-layer': "M0 500 L0 400 C 150 350, 350 320, 600 400 S 850 450, 1000 350 L1000 500 Z",
                    'river-path': "M100 480 Q 250 430, 400 480 T 700 430 T 900 480 L900 500 L100 500 Z",
                    'city-silhouette': "", // No city in default forest
                    'forest-silhouette': "M10 420 C 12 400, 18 390, 25 400 C 32 390, 38 400, 40 420 Z M50 430 C 52 410, 58 400, 65 410 C 72 400, 78 410, 80 430 Z M90 410 C 92 390, 98 380, 105 390 C 112 380, 118 390, 120 410 Z M130 440 C 132 420, 138 410, 145 420 C 152 410, 158 420, 160 440 Z M170 425 C 172 405, 178 395, 185 405 C 192 395, 198 405, 200 425 Z M210 400 C 212 380, 218 370, 225 380 C 232 370, 238 380, 240 400 Z M250 435 C 252 415, 258 405, 265 415 C 272 405, 278 415, 280 435 Z M290 415 C 292 395, 298 385, 305 395 C 312 385, 318 395, 320 415 Z",
                    'castle-silhouette': "" // No castle in default forest
                },
                weatherTypes: ['clear', 'cloudy', 'rainy', 'windy'],
                tempRangeC: [5, 25],
                landscapeColor: '#2c3e50',
                skyTheme: 'standard'
            },
            'desert': {
                landscape: {
                    'mountain-layer-1': "M0 500 L0 380 C 150 300, 300 250, 500 300 S 700 350, 1000 280 L1000 500 Z",
                    'mountain-layer-2': "M0 500 L0 420 C 100 380, 250 350, 450 400 S 700 450, 1000 380 L1000 500 Z",
                    'foreground-layer': "M0 500 L0 450 Q 200 400, 500 450 T 1000 400 L1000 500 Z",
                    'river-path': "",
                    'city-silhouette': "",
                    'forest-silhouette': "",
                    'castle-silhouette': ""
                },
                weatherTypes: ['clear', 'windy'], // Could add 'sandstorm'
                tempRangeC: [15, 40],
                landscapeColor: '#b87333', // Sandy brown
                skyTheme: 'standard' // Could have a specific desert sky theme
            },
            'mountains': {
                landscape: {
                    'mountain-layer-1': "M0 500 L0 250 C 150 100, 350 50, 500 150 S 700 200, 1000 100 L1000 500 Z",
                    'mountain-layer-2': "M0 500 L0 300 C 100 180, 300 120, 500 250 S 750 300, 1000 200 L1000 500 Z",
                    'foreground-layer': "M0 500 L0 380 C 120 300, 350 280, 600 350 S 850 400, 1000 300 L1000 500 Z",
                    'river-path': "M50 480 Q 200 450, 350 480 T 600 450 T 800 480 L800 500 L50 500 Z",
                    'city-silhouette': "",
                    'forest-silhouette': "",
                    'castle-silhouette': ""
                },
                weatherTypes: ['clear', 'cloudy', 'windy', 'snowy'],
                tempRangeC: [-5, 15],
                landscapeColor: '#5a5a5a', // Rocky grey
                skyTheme: 'standard'
            },
            'city': {
                landscape: {
                    'mountain-layer-1': "M0 500 L0 400 C 100 380, 200 350, 300 380 S 400 400, 500 350 S 600 300, 700 350 S 800 400, 900 350 S 1000 300, 1000 500 Z",
                    'mountain-layer-2': "M0 500 L0 450 C 100 420, 200 400, 300 420 S 400 450, 500 420 S 600 390, 700 420 S 800 450, 900 420 S 1000 390, 1000 500 Z",
                    'foreground-layer': "M0 500 L0 480 C 100 460, 200 440, 300 460 S 400 480, 500 460 S 600 440, 700 460 S 800 480, 900 460 S 1000 440, 1000 500 Z",
                    'river-path': "",
                    'city-silhouette': "M100 400 L100 300 Q105 295, 110 300 L110 320 Q115 315, 120 320 L120 300 Q125 295, 130 300 L130 400 Z M140 400 L140 280 Q145 275, 150 280 L150 300 Q155 295, 160 300 L160 280 Q165 275, 170 280 L170 400 Z M180 400 L180 340 Q185 335, 190 340 L190 360 Q195 355, 200 360 L200 340 Q205 335, 210 340 L210 400 Z M220 400 L220 310 Q225 305, 230 310 L230 330 Q235 325, 240 330 L240 310 Q245 305, 250 310 L250 400 Z M400 380 L400 320 Q405 315, 410 320 L410 340 Q415 335, 420 340 L420 320 Q425 315, 430 320 L430 380 Z M440 380 L440 300 Q445 295, 450 300 L450 320 Q455 315, 460 320 L460 300 Q465 295, 470 300 L470 380 Z M480 380 L480 340 Q485 335, 490 340 L490 360 Q495 355, 500 360 L500 340 Q505 335, 510 340 L510 380 Z M520 380 L520 310 Q525 305, 530 310 L530 330 Q535 325, 540 330 L540 310 Q545 305, 550 310 L550 380 Z",
                    'forest-silhouette': "",
                    'castle-silhouette': "M700 350 L700 250 C705 240, 715 240, 720 250 L720 280 C725 270, 735 270, 740 280 L740 350 Z M750 350 L750 220 C755 210, 765 210, 770 220 L770 240 C775 230, 785 230, 790 240 L790 350 Z M800 350 L800 300 C805 290, 815 290, 820 300 L820 320 C825 310, 835 310, 840 320 L840 350 Z"
                },
                weatherTypes: ['clear', 'cloudy', 'rainy'],
                tempRangeC: [10, 30],
                landscapeColor: '#4a4a4a', // City grey
                skyTheme: 'standard'
            },
            'dungeon': {
                landscape: { // Simplified dungeon entrance/cave
                    'mountain-layer-1': "M0 500 L0 350 C 150 250, 350 200, 500 250 S 700 300, 1000 200 L1000 500 Z",
                    'mountain-layer-2': "M0 500 L0 400 C 100 350, 200 320, 300 350 S 400 380, 500 350 S 600 320, 700 350 S 800 380, 900 350 S 1000 320, 1000 500 Z",
                    'foreground-layer': "M0 500 L0 450 C 100 420, 200 400, 300 420 S 400 450, 500 420 S 600 400, 700 420 S 800 450, 900 420 S 1000 400, 1000 500 Z",
                    'river-path': "",
                    'city-silhouette': "",
                    'forest-silhouette': "",
                    'castle-silhouette': ""
                },
                weatherTypes: ['foggy'], // Always foggy/gloomy inside
                tempRangeC: [5, 15],
                landscapeColor: '#303030', // Dark stone
                skyTheme: 'curse-of-strahd'
            },
            'arctic': {
                landscape: {
                    'mountain-layer-1': "M0 500 L0 300 C 100 200, 250 150, 400 250 S 600 300, 750 200 S 900 100, 1000 250 L1000 500 Z",
                    'mountain-layer-2': "M0 500 L0 350 C 120 280, 300 220, 500 350 S 750 400, 1000 300 L1000 500 Z",
                    'foreground-layer': "M0 500 L0 400 C 150 350, 350 320, 600 400 S 850 450, 1000 350 L1000 500 Z",
                    'river-path': "",
                    'city-silhouette': "",
                    'forest-silhouette': "",
                    'castle-silhouette': ""
                },
                weatherTypes: ['snowy', 'blizzard', 'windy'],
                tempRangeC: [-30, 0],
                landscapeColor: '#a0c0e0', // Icy white/blue
                skyTheme: 'icewind-dale'
            },
            'coast': {
                landscape: {
                    'mountain-layer-1': "M0 500 L0 400 C 100 350, 250 300, 400 350 S 600 400, 750 350 S 900 300, 1000 350 L1000 500 Z",
                    'mountain-layer-2': "M0 500 L0 450 C 100 420, 250 400, 400 420 S 600 450, 750 420 S 900 400, 1000 420 S 1000 440, 1000 500 Z",
                    'foreground-layer': "M0 500 L0 480 C 100 460, 250 450, 400 460 S 600 480, 750 460 S 900 450, 1000 460 S 1000 440, 1000 500 Z",
                    'river-path': "M0 500 L0 490 Q 500 470, 1000 490 L1000 500 Z", // Simplified water line
                    'city-silhouette': "",
                    'forest-silhouette': "",
                    'castle-silhouette': ""
                },
                weatherTypes: ['clear', 'cloudy', 'rainy', 'windy'],
                tempRangeC: [0, 20],
                landscapeColor: '#6a7e8a', // Coastal grey-blue
                skyTheme: 'standard'
            }
        };


        // SVG Icons for weather indicator (improved)
        const WEATHER_ICONS = {
            'clear': '<path d="M12 2.5c-5.25 0-9.5 4.25-9.5 9.5s4.25 9.5 9.5 9.5 9.5-4.25 9.5-9.5-4.25-9.5-9.5-9.5zm-.08 17.5c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zM12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6z"/>', // Sun
            'cloudy': '<path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/>', // Cloud
            'rainy': '<path d="M17.5 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6z"/>', // Rain (simplified, cloud with drops)
            'snowy': '<path d="M12 17.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm-6 0c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm12 0c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM12 7c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/>', // Snow (cloud with snowflakes)
            'foggy': '<path d="M20 11H4c-1.1 0-2 .9-2 2s.9 2 2 2h16c1.1 0 2-.9 2-2s-.9-2-2-2zM4 17h16c1.1 0 2-.9 2-2s-.9-2-2-2H4c-1.1 0-2 .9-2 2s.9 2 2 2zM20 7H4c-1.1 0-2 .9-2 2s.9 2 2 2h16c1.1 0 2-.9 2-2s-.9-2-2-2z"/>', // Fog (wavy lines)
            'windy': '<path d="M12 6.5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zM22 12h-2c0-4.41-3.59-8-8-8V2c5.52 0 10 4.48 10 10zm-3.5 0h-2c0-2.76-2.24-5-5-5V5.5c3.59 0 6.5 2.91 6.5 6.5z"/>', // Wind (simplified)
            'blizzard': '<path d="M12 17.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm-6 0c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm12 0c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM12 7c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/>' // Blizzard (snow + wind)
        };

        const WIND_DIRECTIONS = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];

        // Allowed emojis for events
        const ALLOWED_EMOJIS = [
            '⚔️', '📜', '🔔', '✨', '🔥', '💧', '🌲', '⛰️', '🏘️', '💀', '🌕', '☀️', '☁️', '🌧️', '❄️', '💨', '🧭', '🗺️', '💰', '🛡️', '🧪', '🔑', '🚪', '❓', '❕', '⚠️', '💡', '💬', '👣', '🐎', '🏕️', '🛌', '🍻', '🍖', '🍎', '🍄', '🕸️', '🕷️', '🐺', '🐻', '🐉', '👻', '🧙', '🧝', '👹', '😇', '😈', '👑', '💎', '🏺', '🗝️', '⏳', '�️'
        ];


        // Random events that can occur
        const EVENTS = [
            { name: 'lightning', probability: 0.005, weatherRequired: ['rainy', 'blizzard'], message: 'A flash of lightning illuminates the sky!' }, // Increased probability
            { name: 'gust_of_wind', probability: 0.007, weatherRequired: ['clear', 'cloudy', 'windy'], message: 'A sudden gust of wind whips through the air.' }, // Increased probability
            { name: 'distant_howl', probability: 0.005, timeRequired: [20, 5], message: 'A chilling howl echoes from the distance.' }, // 8 PM to 5 AM, Increased probability
            { name: 'bird_flock', probability: 0.006, timeRequired: [6, 18], message: 'A flock of birds flies overhead.' }, // 6 AM to 6 PM, Increased probability
            { name: 'shooting_star', probability: 0.005, timeRequired: [20, 5], message: 'A shooting star streaks across the night sky!' } // 8 PM to 5 AM, Increased probability
        ];


        // --- Audio Synths & Effects (Tone.js) ---
        let windNoise, rainNoise, nightAmbience;
        let windVolume = new Tone.Volume(-Infinity).toDestination();
        let rainVolume = new Tone.Volume(-Infinity).toDestination();
        let ambienceVolume = new Tone.Volume(-Infinity).toDestination();

        function initAudio() {
            if (audioContextInitialized) return;

            // Wind Noise (WhiteNoise filtered)
            windNoise = new Tone.Noise('white').connect(new Tone.Filter(400, 'lowpass')).connect(windVolume);
            windNoise.start();

            // Rain Noise (PinkNoise filtered)
            rainNoise = new Tone.Noise('pink').connect(new Tone.Filter(800, 'lowpass')).connect(rainVolume);
            rainNoise.start();

            // Night Ambience (BrownNoise filtered, subtle)
            nightAmbience = new Tone.Noise('brown').connect(new Tone.Filter(200, 'lowpass')).connect(ambienceVolume);
            nightAmbience.start();

            audioContextInitialized = true;
            console.log("Audio context initialized.");
        }

        function updateAudioLevels() {
            if (!audioContextInitialized || isMuted) {
                windVolume.volume.value = -Infinity;
                rainVolume.volume.value = -Infinity;
                ambienceVolume.volume.value = -Infinity;
                return;
            }

            const currentHour = (inGameTimeMinutes % MINUTES_IN_DAY) / MINUTES_IN_HOUR;

            // Adjust night ambience based on time
            if (currentHour >= 20 || currentHour < 5) { // 8 PM to 5 AM
                ambienceVolume.volume.value = -15; // Moderate volume for night ambience
            } else {
                ambienceVolume.volume.value = -Infinity; // Mute during day
            }

            // Adjust weather sounds
            const weatherConfig = WEATHER_TYPES[currentCampaignTheme][currentWeather];
            if (weatherConfig) {
                if (currentWeather.includes('rainy') || currentWeather === 'blizzard') { // Check for 'rainy' and 'gloomy rain'
                    rainVolume.volume.value = -10; // Louder rain/blizzard
                    windVolume.volume.value = -15 + (weatherConfig.windEffect * 5); // Wind with rain/blizzard
                } else if (currentWeather === 'windy') {
                    windVolume.volume.value = -10; // Louder wind
                    rainVolume.volume.value = -Infinity;
                } else {
                    rainVolume.volume.value = -Infinity;
                    windVolume.volume.value = -Infinity;
                }
            } else {
                rainVolume.volume.value = -Infinity;
                windVolume.volume.value = -Infinity;
            }

            // Apply global mute
            if (isMuted) {
                windVolume.volume.value = -Infinity;
                rainVolume.volume.value = -Infinity;
                ambienceVolume.volume.value = -Infinity;
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            if (isMuted) {
                volumeIcon.innerHTML = `<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .9-.2 1.76-.51 2.59l1.59 1.59c.9-.99 1.42-2.3 1.42-3.84 0-4.27-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27l4.91 4.91-1.64 1.64-3.27-3.27V15h3v6h4v-3.27l4.91 4.91 1.27-1.27L4.27 3zm10.73 11.25l-2.92-2.92.92-.92 2.92 2.92.92-.92-2.92-2.92-1.27-1.27-1.64-1.64L14 3.23v2.06c.79.25 1.5.67 2.11 1.22l-4.24 4.24z"/>`; // Mute icon
            } else {
                volumeIcon.innerHTML = `<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>`; // Volume icon
            }
            updateAudioLevels();
        }


        // --- Utility Functions ---

        /**
         * Shows a custom message box instead of alert().
         * @param {string} message - The message to display.
         */
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBox.style.display = 'flex';
        }

        /**
         * Closes the custom message box.
         */
        function closeMessageBox() {
            messageBox.style.display = 'none';
        }

        /**
         * Gets a CSS custom property value.
         * @param {string} varName - The name of the CSS variable (e.g., '--sky-dawn-top').
         * @returns {string} The CSS variable value.
         */
        function getCssVar(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }

        /**
         * Interpolates between two colors.
         * Colors are expected in 'rgb(r, g, b)' or '#rrggbb' format.
         * @param {string} color1 - Start color.
         * @param {string} color2 - End color.
         * @param {number} factor - Interpolation factor (0 to 1).
         * @returns {string} Interpolated color in rgb() format.
         */
        function interpolateColor(color1, color2, factor) {
            const parseColor = (c) => {
                if (c.startsWith('#')) {
                    return [parseInt(c.substring(1, 3), 16), parseInt(c.substring(3, 5), 16), parseInt(c.substring(5, 7), 16)];
                } else if (c.startsWith('rgb')) {
                    return c.match(/\d+/g).map(Number);
                }
                return [0, 0, 0]; // Default to black
            };

            const rgb1 = parseColor(color1);
            const rgb2 = parseColor(color2);

            const r = Math.round(rgb1[0] + factor * (rgb2[0] - rgb1[0]));
            const g = Math.round(rgb1[1] + factor * (rgb2[1] - rgb1[1]));
            const b = Math.round(rgb1[2] + factor * (rgb2[2] - rgb1[2]));

            return `rgb(${r}, ${g}, ${b})`;
        }

        /**
         * Triggers a lightning flash effect.
         */
        function flashLightning() {
            document.documentElement.style.setProperty('--lightning-opacity', 1);
            setTimeout(() => {
                document.documentElement.style.setProperty('--lightning-opacity', 0);
            }, getCssVar('--lightning-flash-duration').replace('s', '') * 1000);
        }

        /**
         * Triggers a shooting star effect.
         */
        function triggerShootingStar() {
            const startX = Math.random() * window.innerWidth * 0.8; // Starts from 0-80% of screen width
            const startY = Math.random() * window.innerHeight * 0.4; // Starts from 0-40% of screen height
            const endX = startX + (Math.random() * 200 + 100); // Ends 100-300px to the right
            const endY = startY + (Math.random() * 100 + 50); // Ends 50-150px down (diagonal)

            shootingStarEffect.style.left = `${startX}px`;
            shootingStarEffect.style.top = `${startY}px`;
            document.documentElement.style.setProperty('--shooting-star-opacity', 1);

            // Animate the movement
            shootingStarEffect.style.transition = `transform ${getCssVar('--shooting-star-duration')} ease-out, opacity ${getCssVar('--shooting-star-duration')} ease-out`;
            shootingStarEffect.style.transform = `translate(${endX - startX}px, ${endY - startY}px)`;

            setTimeout(() => {
                document.documentElement.style.setProperty('--shooting-star-opacity', 0);
                // Reset transform after transition to allow new animation from original position
                shootingStarEffect.style.transition = 'none';
                shootingStarEffect.style.transform = 'translate(-50%, -50%)';
            }, getCssVar('--shooting-star-duration').replace('s', '') * 1000);
        }


        /**
         * Triggers a random event based on probability and current conditions.
         */
        function triggerRandomEvent() {
            const currentHour = (inGameTimeMinutes % MINUTES_IN_DAY) / MINUTES_IN_HOUR;

            // Campfire visibility logic (increased probability for testing)
            if ((currentHour >= 20 || currentHour < 5) && Math.random() < 0.1) { // 8 PM to 5 AM, 10% chance
                campfireElement.style.opacity = 1;
                setTimeout(() => {
                    campfireElement.style.opacity = 0;
                }, 5000); // Visible for 5 seconds
            } else {
                campfireElement.style.opacity = 0;
            }

            for (const event of EVENTS) {
                if (Math.random() < event.probability) {
                    // Check weather requirements
                    if (event.weatherRequired && !event.weatherRequired.includes(currentWeather)) {
                        continue;
                    }
                    // Check time requirements
                    if (event.timeRequired) {
                        const [start, end] = event.timeRequired;
                        if (start <= end) {
                            if (currentHour < start || currentHour >= end) {
                                continue;
                            }
                        } else { // Crosses midnight
                            if (!(currentHour >= start || currentHour < end)) {
                                continue;
                            }
                        }
                    }

                    // Trigger the event
                    if (event.name === 'lightning') {
                        flashLightning();
                        showMessageBox(event.message);
                    } else if (event.name === 'gust_of_wind') {
                        document.documentElement.style.setProperty('--wind-strength', 1.5); // Temporary strong wind
                        setTimeout(() => {
                            updateWeatherEffects(currentHour); // Revert to normal wind for current weather
                        }, 2000);
                        showMessageBox(event.message);
                    } else if (event.name === 'shooting_star') {
                        triggerShootingStar();
                        showMessageBox(event.message);
                    }
                    else {
                        showMessageBox(event.message);
                    }
                    break; // Only trigger one event per tick
                }
            }
        }

        // --- Particle System Classes (for Rain and Snow) ---

        class Particle {
            constructor(x, y, color, speed, size, windStrength) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.speed = speed;
                this.size = size;
                this.windStrength = windStrength;
                this.initialX = x; // For horizontal drift
            }

            update() {
                this.y += this.speed;
                this.x += this.windStrength * (this.speed / 10); // Horizontal drift based on wind and vertical speed
                if (this.y > weatherCanvas.height) {
                    this.y = 0; // Reset to top
                    this.x = this.initialX + (Math.random() * 50 - 25); // Slight horizontal variation on reset
                }
            }

            draw(ctx) {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.size, this.size * 2); // Rectangular for rain, square for snow
            }
        }

        class Raindrop extends Particle {
            constructor(x, y, color, speed, windStrength) {
                super(x, y, color, speed, 1, windStrength); // Raindrops are thin
                this.size = 1 + Math.random(); // Slight variation in width
                this.length = 5 + Math.random() * 10; // Length of the streak
            }

            draw(ctx) {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.size, this.length);
            }
        }

        class Snowflake extends Particle {
            constructor(x, y, color, speed, windStrength) {
                super(x, y, color, speed, 2 + Math.random() * 2, windStrength); // Snowflakes are larger and more varied
            }

            draw(ctx) {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size / 2, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        let particles = [];
        let particleType = null; // 'rain' or 'snow'

        function createParticles(count, color, speed, type, windStrength) {
            particles = [];
            particleType = type;
            for (let i = 0; i < count; i++) {
                const x = Math.random() * weatherCanvas.width;
                const y = Math.random() * weatherCanvas.height;
                if (type === 'rain') {
                    particles.push(new Raindrop(x, y, color, speed + (Math.random() * speed * 0.5), windStrength));
                } else if (type === 'snow') {
                    particles.push(new Snowflake(x, y, color, speed + (Math.random() * speed * 0.5), windStrength));
                }
            }
        }

        function animateParticles() {
            ctx.clearRect(0, 0, weatherCanvas.width, weatherCanvas.height);
            for (const particle of particles) {
                particle.update();
                particle.draw(ctx);
            }
            requestAnimationFrame(animateParticles);
        }

        // --- Core Functions ---

        /**
         * Updates the in-game time display.
         */
        function updateTimeDisplay() {
            const totalMinutes = inGameTimeMinutes;
            const currentDay = Math.floor(totalMinutes / MINUTES_IN_DAY) + 1;
            const minutesIntoDay = totalMinutes % MINUTES_IN_DAY;
            const currentHour = Math.floor(minutesIntoDay / MINUTES_IN_HOUR);
            const currentMinute = minutesIntoDay % MINUTES_IN_HOUR;

            const ampm = currentHour >= 12 ? 'PM' : 'AM';
            const displayHour = currentHour % 12 === 0 ? 12 : currentHour % 12;
            const displayMinute = String(currentMinute).padStart(2, '0');

            inGameTimeDisplay.textContent = `Day ${currentDay}, ${displayHour}:${displayMinute} ${ampm}`;

            // Update event modal current day
            eventDayInput.value = currentDay;
        }

        /**
         * Updates the visual elements (sky, sun, moon, effects) based on in-game time.
         */
        function updateVisuals() {
            const currentHourFloat = (inGameTimeMinutes % MINUTES_IN_DAY) / MINUTES_IN_HOUR;

            // --- Sky Gradients ---
            let topColor = getCssVar('--sky-midday-top');
            let bottomColor = getCssVar('--sky-midday-bottom');

            // Use biome's sky theme if defined, otherwise standard
            const activeSkyTheme = BIOMES[currentBiome]?.skyTheme || 'standard';
            const transitions = SKY_TRANSITIONS[activeSkyTheme];

            for (const transition of transitions) {
                const { startHour, endHour, topStart, bottomStart, topEnd, bottomEnd } = transition;
                let effectiveStartHour = startHour;
                let effectiveEndHour = endHour;

                // Handle transitions that cross midnight (e.g., 20:00 to 04:00)
                if (endHour < startHour) {
                    if (currentHourFloat >= startHour && currentHourFloat < 24) {
                        effectiveEndHour = 24;
                    } else if (currentHourFloat >= 0 && currentHourFloat < endHour) {
                        effectiveStartHour = 0;
                    } else {
                        continue;
                    }
                }

                if (currentHourFloat >= effectiveStartHour && currentHourFloat < effectiveEndHour) {
                    const progress = (currentHourFloat - effectiveStartHour) / (effectiveEndHour - effectiveStartHour);
                    topColor = interpolateColor(topStart, topEnd, progress);
                    bottomColor = interpolateColor(bottomStart, bottomEnd, progress);
                    break;
                }
            }

            document.documentElement.style.setProperty('--current-sky-top', topColor);
            document.documentElement.style.setProperty('--current-sky-bottom', bottomColor);

            // --- Sun and Moon Positions & Opacity (Shared Arc) ---
            // Normalize currentHourFloat to a 0-1 range representing the full 24-hour cycle
            const timeProgress = currentHourFloat / HOURS_IN_DAY;

            // X position: Always moves from left (0%) to right (100%) over 24 hours
            const celestialX = timeProgress * 100;

            let celestialY;
            let sunOpacity;
            let sunGlow;
            let moonOpacity;

            if (currentCampaignTheme === 'icewind-dale') {
                // Icewind Dale: Sun stays low, dimmed, perpetual twilight
                celestialY = 70 - (Math.sin(timeProgress * Math.PI) * 10); // Stays mostly between 60-70% (low)
                sunOpacity = 0.3; // Always dimmed
                sunGlow = 0.1; // Very subtle glow
                moonOpacity = currentHourFloat >= 19 || currentHourFloat < 5 ? 0.6 : 0; // Moon still visible at night
            } else {
                // Standard behavior
                celestialY = 80 - (Math.sin(timeProgress * Math.PI) * 70); // Arc from 80% (horizon) to 10% (zenith)

                // Sun opacity: High during day, fades to 0 at horizon
                sunOpacity = 0;
                sunGlow = 0;
                if (currentHourFloat >= 5 && currentHourFloat < 19) {
                    const sunActiveProgress = (currentHourFloat - 5) / (19 - 5);
                    sunOpacity = Math.sin(sunActiveProgress * Math.PI);
                    sunGlow = Math.max(0.2, sunOpacity * 1.5);
                }

                // Moon opacity: High during night, fades to 0 at horizon
                moonOpacity = 0;
                if (currentHourFloat >= 19 || currentHourFloat < 5) {
                    let moonActiveProgress;
                    if (currentHourFloat >= 19) {
                        moonActiveProgress = (currentHourFloat - 19) / (24 - 19 + 5);
                    } else { // After midnight, before 5 AM
                        moonActiveProgress = (currentHourFloat + 5) / (24 - 19 + 5);
                    }
                    moonOpacity = Math.sin(moonActiveProgress * Math.PI);
                }
            }

            sunElement.style.setProperty('--sun-x-pos', `${celestialX}%`);
            sunElement.style.setProperty('--sun-y-pos', `${celestialY}%`);
            sunElement.style.setProperty('--sun-glow-intensity', sunGlow);
            sunElement.style.opacity = sunOpacity;

            moonElement.style.setProperty('--moon-x-pos', `${celestialX}%`); // Moon follows same X
            moonElement.style.setProperty('--moon-y-pos', `${celestialY}%`); // Moon follows same Y
            moonElement.style.opacity = moonOpacity;

            // --- Stars Visibility ---
            starsElement.style.setProperty('--stars-opacity', currentHourFloat >= 20 || currentHourFloat < 5 ? 1 : 0);

            // --- Atmospheric Effects Visibility (Clouds, Aurora, Heat Haze) ---
            // Base cloud opacity, can be overridden by weather
            cloudsLayer1.style.opacity = currentHourFloat > 4 && currentHourFloat < 20 ? 0.1 : 0;
            cloudsLayer2.style.opacity = currentHourFloat > 4 && currentHourFloat < 20 ? 0.08 : 0;

            auroraElement.style.setProperty('--aurora-opacity', currentHourFloat >= 22 || currentHourFloat < 3 ? 0.5 : 0);
            heatHazeElement.style.setProperty('--heat-haze-opacity', currentHourFloat >= 11 && currentHourFloat < 15 ? 0.6 : 0);

            // --- Landscape Shadows & Color ---
            let landscapeColor;
            let landscapeShadowOffsetX = 0;
            let landscapeShadowOffsetY = 0;
            let landscapeShadowBlur = 0;
            let landscapeShadowOpacity = 0;
            let landscapeFilter = 'none';

            // Use biome's landscape color
            landscapeColor = BIOMES[currentBiome]?.landscapeColor || getCssVar('--landscape-color');

            // Apply theme-specific landscape filter first
            const weatherConfigForFilter = WEATHER_TYPES[currentCampaignTheme][currentWeather];
            if (weatherConfigForFilter && weatherConfigForFilter.landscapeFilter) {
                landscapeFilter = weatherConfigForFilter.landscapeFilter;
            } else if (currentCampaignTheme === 'icewind-dale') {
                landscapeFilter = 'saturate(0.5) brightness(1.2)';
            } else if (currentCampaignTheme === 'curse-of-strahd') {
                landscapeFilter = 'saturate(0.3) contrast(1.2) brightness(0.8)';
            } else { // Standard
                if (currentHourFloat >= 5 && currentHourFloat < 19) { // Day
                    if (currentHourFloat < 12) { // Morning - shadow to the west (right)
                        landscapeShadowOffsetX = (currentHourFloat - 5) * 5; // Increases from 0 to 35px
                        landscapeShadowOffsetY = 10;
                        landscapeShadowBlur = 10 + (currentHourFloat - 5) * 2;
                        landscapeShadowOpacity = 0.3 + (currentHourFloat - 5) * 0.05;
                    } else { // Afternoon - shadow to the east (left)
                        landscapeShadowOffsetX = (19 - currentHourFloat) * -5; // Increases from 0 to -35px
                        landscapeShadowOffsetY = 10;
                        landscapeShadowBlur = 10 + (19 - currentHourFloat) * 2;
                        landscapeShadowOpacity = 0.3 + (19 - currentHourFloat) * 0.05;
                    }
                }
                landscapeFilter = 'none'; // No special filter for standard
            }


            document.documentElement.style.setProperty('--landscape-color', landscapeColor);
            document.documentElement.style.setProperty('--landscape-shadow-offset-x', `${landscapeShadowOffsetX}px`);
            document.documentElement.style.setProperty('--landscape-shadow-offset-y', `${landscapeShadowOffsetY}px`);
            document.documentElement.style.setProperty('--landscape-shadow-blur', `${landscapeShadowBlur}px`);
            document.documentElement.style.setProperty('--landscape-shadow-opacity', landscapeShadowOpacity);
            document.documentElement.style.setProperty('--landscape-filter', landscapeFilter);

            // Adjust landscape scrolling speed based on wind strength
            const baseScrollDuration = 180; // seconds for one full scroll (slower now)
            const windFactor = 1 + (parseFloat(document.documentElement.style.getPropertyValue('--wind-strength')) * 1); // More wind, faster scroll (reduced impact)
            landscapeSVG.style.animationDuration = `${baseScrollDuration / windFactor}s`;


            // --- Update Weather Effects & Indicator ---
            updateWeatherEffects(currentHourFloat);
            updateWeatherIndicator();
            updateAudioLevels(); // Update audio based on new visuals/weather
            updateTimeline(); // Update timeline position
        }

        /**
         * Chooses a random weather type from the available options for the current theme and biome.
         * @returns {string} The new random weather type.
         */
        function getRandomWeatherType() {
            // Get weather types explicitly defined for the current campaign theme
            const themeSpecificWeathers = Object.keys(WEATHER_TYPES[currentCampaignTheme]);

            // Get weather types allowed by the current biome
            const biomeAllowedWeathers = BIOMES[currentBiome]?.weatherTypes || Object.keys(WEATHER_TYPES['standard']);

            // Find the intersection of theme-specific and biome-allowed weathers
            const availableWeathers = themeSpecificWeathers.filter(weatherKey => biomeAllowedWeathers.includes(weatherKey));

            if (availableWeathers.length === 0) {
                console.warn(`No valid weather types found for biome '${currentBiome}' and theme '${currentCampaignTheme}'. Defaulting to 'clear'.`);
                return 'clear'; // Fallback
            }
            return availableWeathers[Math.floor(Math.random() * availableWeathers.length)];
        }

        /**
         * Sets a new random duration for the current weather.
         */
        function setNewWeatherDuration() {
            // Use weather types specific to the current campaign theme
            const weatherConfig = WEATHER_TYPES[currentCampaignTheme][currentWeather];

            if (weatherConfig) {
                weatherDurationMinutes = Math.floor(Math.random() * (weatherConfig.maxDuration - weatherConfig.minDuration + 1)) + weatherConfig.minDuration;
            } else {
                weatherDurationMinutes = 120; // Default if config not found
            }
            nextWeatherChangeTime = inGameTimeMinutes + weatherDurationMinutes;
            console.log(`Weather changed to: ${currentWeather}. Next change in ${weatherDurationMinutes} minutes (in-game).`);
        }


        /**
         * Determines and applies current weather effects based on campaign theme and time.
         * @param {number} currentHourFloat - Current in-game hour as a float (0-24).
         */
        function updateWeatherEffects(currentHourFloat) {
            // Only change weather randomly if no manual selection is active
            if (!manualWeatherSelection && isRunning && !isDraggingSun && !isDraggingMoon && inGameTimeMinutes >= nextWeatherChangeTime) {
                currentWeather = getRandomWeatherType();
                setNewWeatherDuration();
            } else if (manualWeatherSelection) {
                currentWeather = manualWeatherSelection;
            }

            // Reset all weather effects opacities and clear canvas
            document.documentElement.style.setProperty('--fog-opacity', 0);
            document.documentElement.style.setProperty('--wind-strength', 0);
            particles = []; // Clear particles
            ctx.clearRect(0, 0, weatherCanvas.width, weatherCanvas.height);


            // Apply active weather effect
            const weatherConfig = WEATHER_TYPES[currentCampaignTheme][currentWeather];
            if (weatherConfig) {
                document.documentElement.style.setProperty('--wind-strength', weatherConfig.windEffect);

                if (weatherConfig.particleColor && weatherConfig.particleDensity > 0) {
                    createParticles(weatherConfig.particleDensity, weatherConfig.particleColor, weatherConfig.particleSpeed, currentWeather.includes('rainy') ? 'rain' : 'snow', weatherConfig.windEffect);
                }

                if (currentWeather === 'foggy') {
                    document.documentElement.style.setProperty('--fog-opacity', 0.7);
                } else {
                    document.documentElement.style.setProperty('--fog-opacity', 0);
                }

                // Adjust cloud opacity for general cloudy conditions
                if (currentWeather === 'cloudy' || currentWeather === 'overcast') { // Added 'overcast' for Strahd
                    cloudsLayer1.style.opacity = 0.25;
                    cloudsLayer2.style.opacity = 0.2;
                } else {
                    // Revert to time-based cloud opacity if not explicitly cloudy
                    cloudsLayer1.style.opacity = currentHourFloat > 4 && currentHourFloat < 20 ? 0.1 : 0;
                    cloudsLayer2.style.opacity = currentHourFloat > 4 && currentHourFloat < 20 ? 0.08 : 0;
                }

                // Update temperature based on biome and weather
                const biomeTempRange = BIOMES[currentBiome]?.tempRangeC || [5, 25]; // Default to forest range
                const [minTemp, maxTemp] = weatherConfig.tempC || biomeTempRange; // Use weather temp if available, else biome
                currentTemperatureC = minTemp + Math.random() * (maxTemp - minTemp); // Random temp within range
            }


            // Adjust cloud speed based on wind strength
            const baseCloudDuration1 = 180; // seconds
            const baseCloudDuration2 = 180 * 0.8; // seconds
            // Wind strength increases speed, so duration decreases
            cloudsLayer1.style.animationDuration = `${baseCloudDuration1 / (1 + parseFloat(document.documentElement.style.getPropertyValue('--wind-strength')) * 1.5)}s`;
            cloudsLayer2.style.animationDuration = `${baseCloudDuration2 / (1 + parseFloat(document.documentElement.style.getPropertyValue('--wind-strength')) * 1.5)}s`;
        }

        /**
         * Updates the weather icon and temperature display.
         */
        function updateWeatherIndicator() {
            weatherIconSvg.innerHTML = WEATHER_ICONS[currentWeather] || WEATHER_ICONS['clear']; // Fallback to clear
            // Use weather description from current biome's weather types, or default
            weatherDescription.textContent = WEATHER_TYPES[currentCampaignTheme][currentWeather]?.description || 'Unknown';

            // Clear existing wind lines
            weatherIconDisplay.querySelectorAll('.wind-line').forEach(el => el.remove());

            const windStrength = parseFloat(document.documentElement.style.getPropertyValue('--wind-strength'));
            if (windStrength > 0.3) { // Show wind lines if wind is significant
                const numLines = Math.min(3, Math.floor(windStrength * 2)); // More lines for stronger wind
                for (let i = 0; i < numLines; i++) {
                    const windLine = document.createElement('div');
                    windLine.classList.add('wind-line');
                    // Position and length based on index and strength
                    windLine.style.width = `${4 + (i * 1.5)}vmin`;
                    windLine.style.top = `${2 + (i * 2)}vmin`;
                    windLine.style.left = `${2 + (i * 1.5)}vmin`;
                    windLine.style.animationDelay = `${i * 0.3}s`; // Stagger animation
                    weatherIconDisplay.appendChild(windLine);
                }
            }

            // Update wind direction and visibility
            windDirectionDisplay.textContent = `Wind: ${WIND_DIRECTIONS[Math.floor(Math.random() * WIND_DIRECTIONS.length)]}`;
            visibilityDisplay.textContent = `Visibility: ${WEATHER_TYPES[currentCampaignTheme][currentWeather]?.visibility || 'N/A'}`;


            let tempToDisplay = currentTemperatureC;
            let unit = '°C';

            if (displayFahrenheit) {
                tempToDisplay = (currentTemperatureC * 9/5) + 32;
                unit = '°F';
            }
            temperatureDisplay.textContent = `${Math.round(tempToDisplay)}${unit}`;
            tempToggleButton.textContent = displayFahrenheit ? '°C' : '°F';
        }

        /**
         * Toggles the temperature display unit between Celsius and Fahrenheit.
         */
        function toggleTemperatureUnit() {
            displayFahrenheit = !displayFahrenheit;
            updateWeatherIndicator(); // Re-render temperature
        }


        /**
         * The main game loop, updates time and visuals.
         */
        function gameLoop() {
            if (!isRunning) return; // Only run if not paused or dragged

            let minutesToAdd = 0;
            switch (inGameTimeUnit) {
                case 'minute':
                    minutesToAdd = 1;
                    break;
                case 'hour':
                    minutesToAdd = MINUTES_IN_HOUR;
                    break;
                case 'day':
                    minutesToAdd = MINUTES_IN_DAY;
                    break;
            }
            inGameTimeMinutes += minutesToAdd;
            console.log(`Game Loop: Time advancing to ${inGameTimeMinutes} minutes.`); // Added log

            updateTimeDisplay();
            updateVisuals(); // This will also handle weather changes
            triggerRandomEvent();
            checkScheduledEvents(); // This calls the event checker
        }

        /**
         * Starts the time tracker.
         */
        function startTimer() {
            if (!isRunning) {
                const rate = parseFloat(realTimeRateInput.value);
                if (isNaN(rate) || rate <= 0) {
                    showMessageBox('Please enter a valid positive number for the time rate.');
                    return;
                }
                realTimeRateSecondsPerUnit = rate;
                timerInterval = setInterval(gameLoop, realTimeRateSecondsPerUnit * 1000);
                isRunning = true;
                startBtn.classList.add('disabled');
                startBtn.disabled = true;
                pauseBtn.classList.remove('disabled');
                pauseBtn.disabled = false;
                realTimeRateInput.disabled = true; // Disable input while running
                inGameUnitSelect.disabled = true;
                campaignThemeSelect.disabled = true;
                manualWeatherSelect.disabled = true;
                biomeSelect.disabled = true; // Disable biome select while running
                setDayInput.disabled = true; // Disable set day input
                setDayBtn.disabled = true; // Disable set day button
                shortRestBtn.disabled = true; // Disable rest/travel buttons
                longRestBtn.disabled = true;
                travelTimeInput.disabled = true;
                travelUnitSelect.disabled = true;
                travelBtn.disabled = true;
                addEventBtn.disabled = true; // Disable add event button

                // Start landscape scrolling by setting appropriate duration
                const baseScrollDuration = 180; // seconds
                const windFactor = 1 + (parseFloat(document.documentElement.style.getPropertyValue('--wind-strength')) * 1);
                landscapeSVG.style.animationDuration = `${baseScrollDuration / windFactor}s`;


                // Set initial weather duration when starting
                if (!manualWeatherSelection) { // Only set new duration if not manually selected
                    setNewWeatherDuration();
                }
                initAudio(); // Initialize audio context on first user interaction
                Tone.start(); // Start Tone.js audio context
                updateAudioLevels();
            }
        }

        /**
         * Pauses the time tracker.
         */
        function pauseTimer() {
            if (isRunning) {
                clearInterval(timerInterval);
                isRunning = false;
                startBtn.classList.remove('disabled');
                startBtn.disabled = false;
                pauseBtn.classList.add('disabled');
                pauseBtn.disabled = true;
                realTimeRateInput.disabled = false; // Enable input when paused
                inGameUnitSelect.disabled = false;
                campaignThemeSelect.disabled = false;
                manualWeatherSelect.disabled = false;
                biomeSelect.disabled = false; // Enable biome select when paused
                setDayInput.disabled = false; // Enable set day input
                setDayBtn.disabled = false; // Enable set day button
                shortRestBtn.disabled = false; // Enable rest/travel buttons
                longRestBtn.disabled = false;
                travelTimeInput.disabled = false;
                travelUnitSelect.disabled = false;
                travelBtn.disabled = false;
                addEventBtn.disabled = false; // Enable add event button

                // Pause landscape scrolling by setting a very long duration
                landscapeSVG.style.animationDuration = '1000000s'; // Effectively stops it


                updateAudioLevels(); // Mute sounds when paused
            }
        }

        /**
         * Resets the time tracker to its initial state.
         */
        function resetTimer() {
            pauseTimer(); // Ensure timer is stopped
            inGameTimeMinutes = 8 * MINUTES_IN_HOUR; // Reset to 08:00 AM
            updateTimeDisplay();
            // Reset weather to default for the current theme and biome
            manualWeatherSelection = ''; // Clear manual selection
            manualWeatherSelect.value = ''; // Reset dropdown
            currentWeather = getRandomWeatherType(); // Pick a new random starting weather
            setNewWeatherDuration(); // Set duration for this new weather
            updateVisuals();
            startBtn.classList.remove('disabled');
            startBtn.disabled = false;
            pauseBtn.classList.add('disabled');
            pauseBtn.disabled = true;
            realTimeRateInput.disabled = false; // Ensure input is enabled
            inGameUnitSelect.disabled = false;
            campaignThemeSelect.disabled = false;
            manualWeatherSelect.disabled = false;
            biomeSelect.disabled = false; // Enable biome select
            setDayInput.disabled = false; // Enable set day input
            setDayBtn.disabled = false; // Enable set day button
            shortRestBtn.disabled = false; // Enable rest/travel buttons
            longRestBtn.disabled = false;
            travelTimeInput.disabled = false;
            travelUnitSelect.disabled = false;
            travelBtn.disabled = false;
            addEventBtn.disabled = false; // Enable add event button
            scheduledEvents = []; // Clear all scheduled events
            renderScheduledEvents(); // Clear timeline display

            updateAudioLevels(); // Ensure audio state is consistent with reset

            // Ensure landscape scrolling is stopped after reset
            landscapeSVG.style.animationDuration = '1000000s';
        }

        /**
         * Handles change in in-game time unit selection.
         */
        function handleInGameUnitChange() {
            inGameTimeUnit = inGameUnitSelect.value;
            realTimeUnitLabel.textContent = `Real-World Seconds per In-Game ${inGameTimeUnit.charAt(0).toUpperCase() + inGameTimeUnit.slice(1)}`;
        }

        /**
         * Populates the manual weather dropdown based on the current campaign theme and biome.
         */
        function populateManualWeatherDropdown() {
            manualWeatherSelect.innerHTML = ''; // Clear existing options

            // Add 'Random' option
            const randomOption = document.createElement('option');
            randomOption.value = '';
            randomOption.textContent = 'Random';
            manualWeatherSelect.appendChild(randomOption);

            // Get weather types explicitly defined for the current campaign theme
            const themeSpecificWeathers = Object.keys(WEATHER_TYPES[currentCampaignTheme]);

            // Get weather types allowed by the current biome
            const biomeAllowedWeathers = BIOMES[currentBiome]?.weatherTypes || Object.keys(WEATHER_TYPES['standard']);

            // Find the intersection of theme-specific and biome-allowed weathers
            const availableWeathers = themeSpecificWeathers.filter(weatherKey => biomeAllowedWeathers.includes(weatherKey));

            // Add available weather types to the dropdown
            for (const weatherKey of availableWeathers) {
                const option = document.createElement('option');
                option.value = weatherKey;
                option.textContent = WEATHER_TYPES[currentCampaignTheme][weatherKey].description;
                manualWeatherSelect.appendChild(option);
            }

            // Reset manual selection to 'Random' after repopulating
            manualWeatherSelect.value = '';
            manualWeatherSelection = ''; // Also clear the JS variable
        }

        /**
         * Handles change in campaign theme selection.
         */
        function handleCampaignThemeChange() {
            currentCampaignTheme = campaignThemeSelect.value;

            // Set default biome based on theme
            if (currentCampaignTheme === 'icewind-dale') {
                biomeSelect.value = 'arctic';
            } else if (currentCampaignTheme === 'curse-of-strahd') {
                biomeSelect.value = 'dungeon';
            } else {
                biomeSelect.value = 'forest'; // Default for standard
            }
            currentBiome = biomeSelect.value; // Update currentBiome variable

            populateManualWeatherDropdown(); // Repopulate dropdown for new theme
            updateLandscapeSVG(); // Update SVG paths for new biome
            // Reset weather when theme changes
            manualWeatherSelection = ''; // Clear manual selection
            manualWeatherSelect.value = ''; // Reset dropdown
            currentWeather = getRandomWeatherType(); // Pick a new random starting weather
            setNewWeatherDuration(); // Set duration for this new weather
            updateVisuals(); // Re-render visuals based on new theme and weather
        }

        /**
         * Handles manual weather selection.
         */
        function handleManualWeatherChange() {
            manualWeatherSelection = manualWeatherSelect.value;
            if (manualWeatherSelection) {
                currentWeather = manualWeatherSelection;
                // No need to set new duration for manual weather, it stays until changed
            } else {
                // If 'Random' is selected, revert to random weather logic
                currentWeather = getRandomWeatherType();
                setNewWeatherDuration();
            }
            updateVisuals(); // Apply changes immediately
        }

        /**
         * Handles change in biome selection.
         */
        function handleBiomeChange() {
            currentBiome = biomeSelect.value;
            updateLandscapeSVG(); // Update SVG paths
            populateManualWeatherDropdown(); // Update weather dropdown for new biome
            // Reset weather to a random one suitable for the new biome
            manualWeatherSelection = '';
            manualWeatherSelect.value = '';
            currentWeather = getRandomWeatherType();
            setNewWeatherDuration();
            updateVisuals(); // Re-render visuals based on new biome and weather
        }

        /**
         * Updates the landscape SVG paths based on the current biome.
         */
        function updateLandscapeSVG() {
            const biomeData = BIOMES[currentBiome];
            if (biomeData && biomeData.landscape) {
                for (const layerId in biomeData.landscape) {
                    const pathElement = landscapeLayers[layerId];
                    if (pathElement) {
                        pathElement.setAttribute('d', biomeData.landscape[layerId]);
                        // Adjust visibility based on if path is empty
                        pathElement.style.display = biomeData.landscape[layerId] ? 'block' : 'none';
                    }
                }
            }
        }

        /**
         * Sets the in-game day.
         */
        function setDay() {
            const newDay = parseInt(setDayInput.value);
            if (isNaN(newDay) || newDay < 1) {
                showMessageBox('Please enter a valid day (1 or greater).');
                setDayInput.value = Math.floor(inGameTimeMinutes / MINUTES_IN_DAY) + 1; // Reset to current day
                return;
            }
            const currentMinutesIntoDay = inGameTimeMinutes % MINUTES_IN_DAY;
            inGameTimeMinutes = (newDay - 1) * MINUTES_IN_DAY + currentMinutesIntoDay;
            updateTimeDisplay();
            updateVisuals();
            renderScheduledEvents(); // Re-render events on timeline
            showMessageBox(`In-game day moved to Day ${newDay}.`);
        }

        /**
         * Handles short rest (advances time by 1 hour).
         */
        function shortRest() {
            pauseTimer();
            inGameTimeMinutes += MINUTES_IN_HOUR;
            updateTimeDisplay();
            updateVisuals();
            showMessageBox('Party takes a Short Rest (1 Hour).');
        }

        /**
         * Handles long rest (advances time by 8 hours).
         */
        function longRest() {
            pauseTimer();
            inGameTimeMinutes += (HOURS_IN_DAY / 3) * MINUTES_IN_HOUR; // 8 hours
            updateTimeDisplay();
            updateVisuals();
            showMessageBox('Party takes a Long Rest (8 Hours).');
            // Simplified exhaustion check based on D&D 2024 rules (DM discretion)
            // This is a notification for the DM to consider, not an automatic game mechanic.
            showMessageBox('DM Note: After a long rest, consider if the party faces Exhaustion (D&D 2024 rules) if they pushed on previously.');
        }

        /**
         * Handles travel (advances time by custom hours/days).
         */
        function travel() {
            pauseTimer();
            let travelAmount = parseInt(travelTimeInput.value);
            const travelUnit = travelUnitSelect.value;

            if (isNaN(travelAmount) || travelAmount < 1) {
                showMessageBox('Please enter a valid travel duration (1 or greater).');
                travelTimeInput.value = 1;
                return;
            }

            if (travelUnit === 'hour') {
                inGameTimeMinutes += travelAmount * MINUTES_IN_HOUR;
            } else if (travelUnit === 'day') {
                inGameTimeMinutes += travelAmount * MINUTES_IN_DAY;
            }
            updateTimeDisplay();
            updateVisuals();
            showMessageBox(`Party travels for ${travelAmount} ${travelUnit}(s).`);
            renderScheduledEvents(); // Re-render events on timeline
        }

        // --- Event Scheduling Functions ---

        /**
         * Populates the emoji palette in the event modal.
         */
        function populateEmojiPalette() {
            emojiPalette.innerHTML = ''; // Clear existing emojis
            ALLOWED_EMOJIS.forEach(emoji => {
                const span = document.createElement('span');
                span.textContent = emoji;
                span.style.cursor = 'pointer';
                span.style.fontSize = '2.5vmin';
                span.style.padding = '0.5vmin';
                span.style.borderRadius = '5px';
                span.style.transition = 'background 0.2s';
                span.addEventListener('click', () => {
                    eventIconInput.value = emoji;
                    emojiPalette.querySelectorAll('span').forEach(e => e.classList.remove('selected-emoji'));
                    span.classList.add('selected-emoji');
                });
                span.addEventListener('mouseover', () => {
                    if (!span.classList.contains('selected-emoji')) {
                        span.style.background = 'rgba(255, 255, 255, 0.1)';
                    }
                });
                span.addEventListener('mouseout', () => {
                    if (!span.classList.contains('selected-emoji')) {
                        span.style.background = 'transparent';
                    }
                });
                emojiPalette.appendChild(span);
            });
        }

        /**
         * Populates the hour and minute dropdowns in the event modal.
         */
        function populateTimeDropdowns() {
            eventHourSelect.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = String(i).padStart(2, '0');
                eventHourSelect.appendChild(option);
            }

            eventMinuteSelect.innerHTML = '';
            for (let i = 0; i < 60; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = String(i).padStart(2, '0');
                eventMinuteSelect.appendChild(option);
            }
        }

        /**
         * Opens the event scheduling modal.
         */
        function openEventModal() {
            eventModal.style.display = 'flex';
            // Pre-fill with current time
            const currentDay = Math.floor(inGameTimeMinutes / MINUTES_IN_DAY) + 1;
            const currentHour = Math.floor((inGameTimeMinutes % MINUTES_IN_DAY) / MINUTES_IN_HOUR);
            const currentMinute = (inGameTimeMinutes % MINUTES_IN_HOUR);

            // Reset radio buttons and inputs
            scheduleOnDayRadio.checked = true;
            eventDayInput.value = currentDay;
            eventInDaysInput.value = 0;
            eventInWeeksInput.value = 0;

            eventHourSelect.value = currentHour;
            eventMinuteSelect.value = currentMinute;
            eventMessageInput.value = '';
            eventIconInput.value = '';
            populateEmojiPalette(); // Populate emoji palette
            updateEventModalInputs(); // Enable/disable inputs based on radio selection

            // Clear any previously selected emoji highlight
            emojiPalette.querySelectorAll('span').forEach(e => e.classList.remove('selected-emoji'));
        }

        /**
         * Updates the enabled/disabled state of event modal inputs based on radio selection.
         */
        function updateEventModalInputs() {
            eventDayInput.disabled = !scheduleOnDayRadio.checked;
            eventInDaysInput.disabled = !scheduleInDaysRadio.checked;
            eventInWeeksInput.disabled = !scheduleInWeeksRadio.checked;

            // Update default values based on current time when changing radio
            const currentDay = Math.floor(inGameTimeMinutes / MINUTES_IN_DAY) + 1;
            if (scheduleOnDayRadio.checked) {
                eventDayInput.value = currentDay;
            }
        }

        /**
         * Closes the event scheduling modal.
         */
        function closeEventModal() {
            eventModal.style.display = 'none';
        }

        /**
         * Saves a new scheduled event.
         */
        function saveEvent() {
            let targetDay;
            const currentDay = Math.floor(inGameTimeMinutes / MINUTES_IN_DAY) + 1;

            if (scheduleOnDayRadio.checked) {
                targetDay = parseInt(eventDayInput.value);
            } else if (scheduleInDaysRadio.checked) {
                const daysFromNow = parseInt(eventInDaysInput.value);
                targetDay = currentDay + daysFromNow;
            } else if (scheduleInWeeksRadio.checked) {
                const weeksFromNow = parseInt(eventInWeeksInput.value);
                targetDay = currentDay + (weeksFromNow * DAYS_IN_WEEK);
            }

            const hour = parseInt(eventHourSelect.value); // Read from select
            const minute = parseInt(eventMinuteSelect.value); // Read from select
            const message = eventMessageInput.value.trim();
            const icon = eventIconInput.value.trim();

            if (isNaN(targetDay) || targetDay < 1 || isNaN(hour) || hour < 0 || hour > 23 || isNaN(minute) || minute < 0 || minute > 59 || message === '') {
                showMessageBox('Please fill in all event details correctly.');
                return;
            }

            if (icon && !ALLOWED_EMOJIS.includes(icon)) {
                showMessageBox('Please select an emoji from the palette or use one of the allowed emojis.');
                return;
            }

            const eventTimeInMinutes = (targetDay - 1) * MINUTES_IN_DAY + hour * MINUTES_IN_HOUR + minute;

            const newEvent = {
                id: nextEventId++,
                day: targetDay,
                hour: hour,
                minute: minute,
                timeInMinutes: eventTimeInMinutes,
                message: message,
                icon: icon || '🗓️', // Default icon if none provided
                triggered: false
            };

            scheduledEvents.push(newEvent);
            scheduledEvents.sort((a, b) => a.timeInMinutes - b.timeInMinutes); // Keep sorted
            renderScheduledEvents(); // Update timeline
            closeEventModal();
            showMessageBox(`Event "${message}" scheduled for Day ${targetDay}, ${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}.`);
        }

        /**
         * Renders all scheduled events and time increments on the timeline.
         */
        function renderScheduledEvents() {
            // Clear existing event markers and increments
            timelineContent.querySelectorAll('.timeline-event-marker, .timeline-increment-hour, .timeline-increment-day, .timeline-increment-label').forEach(el => el.remove());

            // Set the total width of the timeline content based on a large conceptual duration
            const totalContentMinutes = CONCEPTUAL_TIMELINE_DAYS * MINUTES_IN_DAY;
            timelineContent.style.width = `${totalContentMinutes * PIXELS_PER_MINUTE}px`;

            // Add hour and day increments
            // We need to render increments for the entire conceptual timeline length
            const startHourForIncrements = 0; // Start from Day 1, 00:00
            const endHourForIncrements = CONCEPTUAL_TIMELINE_DAYS * HOURS_IN_DAY;

            for (let h = startHourForIncrements; h < endHourForIncrements; h++) {
                const hourStartMinutes = h * MINUTES_IN_HOUR;
                const positionPx = hourStartMinutes * PIXELS_PER_MINUTE;

                const incrementDiv = document.createElement('div');
                if (h % HOURS_IN_DAY === 0) { // Start of a new day (00:00)
                    incrementDiv.classList.add('timeline-increment-day');
                    const dayLabel = document.createElement('span');
                    dayLabel.classList.add('timeline-increment-label');
                    dayLabel.textContent = `Day ${Math.floor(h / HOURS_IN_DAY) + 1}`;
                    incrementDiv.appendChild(dayLabel);
                } else { // Hour mark
                    incrementDiv.classList.add('timeline-increment-hour');
                }
                incrementDiv.style.left = `${positionPx}px`;

                // Add label for every 2 hours (except for day start, which already has a label)
                if (h % 2 === 0 && h % HOURS_IN_DAY !== 0) {
                    const hourLabel = document.createElement('span');
                    hourLabel.classList.add('timeline-increment-label');
                    hourLabel.textContent = `${String(h % HOURS_IN_DAY).padStart(2, '0')}h`;
                    incrementDiv.appendChild(hourLabel);
                }

                timelineContent.appendChild(incrementDiv);
            }

            // Render scheduled events
            scheduledEvents.forEach(event => {
                const eventMarker = document.createElement('div');
                eventMarker.classList.add('timeline-event-marker');
                eventMarker.dataset.eventId = event.id;
                if (event.triggered) {
                    eventMarker.classList.add('triggered');
                }

                const iconSpan = document.createElement('span');
                iconSpan.classList.add('icon');
                iconSpan.textContent = event.icon;

                const labelSpan = document.createElement('span');
                labelSpan.classList.add('label');
                labelSpan.textContent = `Day ${event.day}, ${String(event.hour).padStart(2, '0')}:${String(event.minute).padStart(2, '0')}`;

                eventMarker.appendChild(iconSpan);
                eventMarker.appendChild(labelSpan);

                // Calculate position relative to the start of the entire timeline content (Day 1, 00:00)
                const positionPx = event.timeInMinutes * PIXELS_PER_MINUTE;

                eventMarker.style.left = `${positionPx}px`;
                eventMarker.title = `Day ${event.day}, ${String(event.hour).padStart(2, '0')}:${String(event.minute).padStart(2, '0')} - ${event.message}`;

                eventMarker.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent drag from triggering this
                    showEventDetails(event.id);
                });

                timelineContent.appendChild(eventMarker);
            });

            // Adjust timeline scroll position to keep current time marker centered
            updateTimeline();
        }

        /**
         * Updates the timeline's scroll position to keep the current time marker centered.
         * This function is called frequently by updateVisuals.
         */
        function updateTimeline() {
            // Calculate the position of the current time relative to the start of the conceptual timeline
            const currentPositionInContentPx = inGameTimeMinutes * PIXELS_PER_MINUTE;

            // The target scrollLeft is such that the currentPositionInContentPx is at the center of the container
            // timelineContainer.offsetWidth / 2 represents the center of the visible timeline viewport
            const targetScrollLeft = currentPositionInContentPx - (timelineContainer.offsetWidth / 2);

            // Smoothly scroll the timeline container
            timelineContainer.scrollLeft = targetScrollLeft;
        }


        /**
         * Displays details of a scheduled event in a modal.
         * @param {number} eventId - The ID of the event to display.
         */
        function showEventDetails(eventId) {
            const event = scheduledEvents.find(e => e.id === eventId);
            if (!event) {
                showMessageBox('Event not found.');
                return;
            }

            currentEventDetailsId = eventId; // Store for deletion
            detailEventIcon.textContent = event.icon;
            detailEventDay.textContent = event.day;
            detailEventTime.textContent = `${String(event.hour).padStart(2, '0')}:${String(event.minute).padStart(2, '0')}`;
            detailEventMessage.textContent = event.message;

            eventDetailsModal.style.display = 'flex';
        }

        /**
         * Closes the event details modal.
         */
        function closeEventDetailsModal() {
            eventDetailsModal.style.display = 'none';
            currentEventDetailsId = null;
        }

        /**
         * Deletes a scheduled event.
         */
        function deleteEvent() {
            if (currentEventDetailsId === null) return;

            scheduledEvents = scheduledEvents.filter(e => e.id !== currentEventDetailsId);
            renderScheduledEvents();
            closeEventDetailsModal();
            showMessageBox('Event deleted successfully.');
        }

        /**
         * Checks for scheduled events that have been triggered.
         */
        function checkScheduledEvents() {
            const currentTotalMinutes = inGameTimeMinutes;
            console.log(`Checking scheduled events at ${currentTotalMinutes} minutes.`); // Debug log
            scheduledEvents.forEach(event => {
                console.log(`  Event ID ${event.id}: Scheduled for ${event.timeInMinutes}, Triggered: ${event.triggered}`); // Debug log
                // Check if the event has not been triggered yet and if the current time has passed or reached the event time
                if (!event.triggered && currentTotalMinutes >= event.timeInMinutes) {
                    console.log(`  >>> EVENT TRIGGERED: ${event.message} at ${currentTotalMinutes} minutes.`); // Debug log
                    showMessageBox(`Event Triggered: Day ${event.day}, ${String(event.hour).padStart(2, '0')}:${String(event.minute).padStart(2, '0')} - ${event.message}`);
                    event.triggered = true; // Mark as triggered
                    pauseTimer(); // Pause timer when event arrives
                    // Optionally, remove the event marker or change its style
                    const marker = timelineContent.querySelector(`[data-event-id="${event.id}"]`);
                    if (marker) {
                        marker.classList.add('triggered'); // Add class to dim/style
                    }
                    // Show event details pop-up
                    showEventDetails(event.id);
                }
            });
        }

        // --- Task List Functions ---
        function toggleTaskList() {
            isTaskListExpanded = !isTaskListExpanded;
            taskListPanel.classList.toggle('visible', isTaskListExpanded);
            taskListToggleButton.classList.toggle('expanded', isTaskListExpanded); // Add/remove expanded class on the toggle button

            // Rotate the arrow icon
            taskListToggleSvg.style.transform = isTaskListExpanded ? 'rotate(180deg)' : 'rotate(0deg)';


            if (isTaskListExpanded) {
                // Set the CSS variable for panel height for the toggle button's transform
                // This needs to be calculated dynamically after the panel is visible
                // Wait for a frame to ensure panel is rendered with content for correct height
                requestAnimationFrame(() => {
                    const panelHeight = taskListPanel.offsetHeight;
                    document.documentElement.style.setProperty('--task-list-height', `${panelHeight}px`);
                });
                newTaskInput.focus(); // Focus on input when expanded
            } else {
                document.documentElement.style.setProperty('--task-list-height', `0px`);
            }
        }

        function addTask() {
            const taskText = newTaskInput.value.trim();
            if (taskText === '') {
                showMessageBox('Task cannot be empty.');
                return;
            }

            const listItem = document.createElement('li');
            listItem.classList.add('task-item');

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.addEventListener('change', () => {
                listItem.classList.toggle('completed', checkbox.checked);
            });

            const textSpan = document.createElement('span');
            textSpan.textContent = taskText;

            const deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-btn');
            deleteButton.textContent = 'X';
            deleteButton.addEventListener('click', () => {
                listItem.remove();
                // Recalculate panel height if it's open
                if (isTaskListExpanded) {
                    // Recalculate height after item removal
                    requestAnimationFrame(() => {
                        const panelHeight = taskListPanel.offsetHeight;
                        document.documentElement.style.setProperty('--task-list-height', `${panelHeight}px`);
                    });
                }
            });

            listItem.appendChild(checkbox);
            listItem.appendChild(textSpan);
            listItem.appendChild(deleteButton);
            tasksList.appendChild(listItem);

            newTaskInput.value = ''; // Clear input
            newTaskInput.focus(); // Keep focus for quick entry

            // Update panel height CSS variable after adding a task
            if (isTaskListExpanded) {
                requestAnimationFrame(() => {
                    const panelHeight = taskListPanel.offsetHeight;
                    document.documentElement.style.setProperty('--task-list-height', `${panelHeight}px`);
                });
            }
        }


        // --- Dragging Functionality ---
        function startDrag(e) {
            initAudio(); // Initialize audio context on drag start
            Tone.start(); // Start Tone.js audio context

            if (e.target === sunElement) {
                isDraggingSun = true;
                sunElement.classList.add('dragging');
            } else if (e.target === moonElement) {
                isDraggingMoon = true;
                moonElement.classList.add('dragging');
            } else {
                return; // Only drag sun/moon
            }

            appContainer.classList.add('dragging');
            dragStartX = e.clientX || e.touches[0].clientX;
            initialInGameTimeMinutes = inGameTimeMinutes;
            pauseTimer(); // Pause automatic progression when dragging
        }

        function doDrag(e) {
            if (!isDraggingSun && !isDraggingMoon) return;

            const currentX = e.clientX || e.touches[0].clientX;
            const deltaX = currentX - dragStartX;

            // Map horizontal drag to time change (e.g., 100px drag = 1 hour)
            // Adjust this sensitivity as needed
            const dragSensitivity = PIXELS_PER_MINUTE; // 3 pixels of drag equals 1 in-game minute
            const timeChangeMinutes = Math.round(deltaX / dragSensitivity); // Round to nearest minute

            inGameTimeMinutes = initialInGameTimeMinutes + timeChangeMinutes;

            // Ensure time doesn't go negative (optional, depends on desired behavior)
            if (inGameTimeMinutes < 0) {
                inGameTimeMinutes = 0;
            }

            updateTimeDisplay();
            updateVisuals();
            renderScheduledEvents(); // Update timeline position during drag
        }

        function endDrag() {
            if (isDraggingSun) {
                isDraggingSun = false;
                sunElement.classList.remove('dragging');
            }
            if (isDraggingMoon) {
                isDraggingMoon = false;
                moonElement.classList.remove('dragging');
            }
            appContainer.classList.remove('dragging');
            // Optionally restart timer if it was running before drag
            // if (wasRunningBeforeDrag) { startTimer(); }
        }


        // --- Event Listeners ---
        startBtn.addEventListener('click', startTimer);
        pauseBtn.addEventListener('click', pauseTimer);
        resetBtn.addEventListener('click', resetTimer);
        messageOkBtn.addEventListener('click', closeMessageBox);
        inGameUnitSelect.addEventListener('change', handleInGameUnitChange);
        campaignThemeSelect.addEventListener('change', handleCampaignThemeChange);
        manualWeatherSelect.addEventListener('change', handleManualWeatherChange); // New event listener
        muteBtn.addEventListener('click', toggleMute);
        tempToggleButton.addEventListener('click', toggleTemperatureUnit);

        // New Event Listeners
        biomeSelect.addEventListener('change', handleBiomeChange);
        setDayBtn.addEventListener('click', setDay);
        shortRestBtn.addEventListener('click', shortRest);
        longRestBtn.addEventListener('click', longRest);
        travelBtn.addEventListener('click', travel);
        addEventBtn.addEventListener('click', openEventModal);
        saveEventBtn.addEventListener('click', saveEvent);
        cancelEventBtn.addEventListener('click', closeEventModal);

        // Event modal radio button listeners
        scheduleOnDayRadio.addEventListener('change', updateEventModalInputs);
        scheduleInDaysRadio.addEventListener('change', updateEventModalInputs);
        scheduleInWeeksRadio.addEventListener('change', updateEventModalInputs);

        // Event details modal listeners
        deleteEventBtn.addEventListener('click', deleteEvent);
        closeDetailsBtn.addEventListener('click', closeEventDetailsModal);


        // Dragging event listeners
        sunElement.addEventListener('mousedown', startDrag);
        moonElement.addEventListener('mousedown', startDrag);
        skyContainer.addEventListener('mousemove', doDrag); // Listen on sky container for wider drag area
        skyContainer.addEventListener('mouseup', endDrag);
        skyContainer.addEventListener('mouseleave', endDrag); // End drag if mouse leaves window

        // Touch events for mobile dragging
        sunElement.addEventListener('touchstart', (e) => startDrag(e));
        moonElement.addEventListener('touchstart', (e) => startDrag(e));
        skyContainer.addEventListener('touchmove', (e) => doDrag(e));
        skyContainer.addEventListener('touchend', endDrag);
        skyContainer.addEventListener('touchcancel', endDrag);

        // Task List Event Listeners
        taskListToggleButton.addEventListener('click', toggleTaskList);
        addTaskBtn.addEventListener('click', addTask);
        newTaskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTask();
            }
        });


        // --- Initial Setup on Load ---
        function initializeApp() {
            inGameTimeMinutes = 8 * MINUTES_IN_HOUR; // Set default start time to 08:00 AM
            handleInGameUnitChange(); // Set initial label for time unit
            populateTimeDropdowns(); // Populate hour/minute dropdowns
            // Initialize biome and update SVG
            // Call handleCampaignThemeChange first to set initial biome based on theme
            handleCampaignThemeChange();
            updateTimeDisplay(); // Set initial time display
            updateVisuals(); // Set initial visual state based on default theme and weather
            renderScheduledEvents(); // Render any initial scheduled events
            populateEmojiPalette(); // Populate emoji palette on load

            // Set canvas size
            weatherCanvas.width = window.innerWidth;
            weatherCanvas.height = skyContainer.clientHeight; // Canvas covers sky area

            // Set initial position for the fixed time marker
            const timelineContainerRect = timelineContainer.getBoundingClientRect();
            timelineCurrentTimeMarker.style.top = `${timelineContainerRect.top}px`;

            window.addEventListener('resize', () => {
                weatherCanvas.width = window.innerWidth;
                weatherCanvas.height = skyContainer.clientHeight;
                // Re-create particles on resize to fit new dimensions
                if (particles.length > 0) {
                    const weatherConfig = WEATHER_TYPES[currentCampaignTheme][currentWeather];
                    if (weatherConfig && weatherConfig.particleColor) {
                        createParticles(weatherConfig.particleDensity, weatherConfig.particleColor, weatherConfig.particleSpeed, currentWeather.includes('rainy') ? 'rain' : 'snow', weatherConfig.windEffect);
                    }
                }
                // Update task list panel height on resize if expanded
                if (isTaskListExpanded) {
                    requestAnimationFrame(() => {
                        const panelHeight = taskListPanel.offsetHeight;
                        document.documentElement.style.setProperty('--task-list-height', `${panelHeight}px`);
                    });
                }
                // Update marker position on resize
                const updatedTimelineContainerRect = timelineContainer.getBoundingClientRect();
                timelineCurrentTimeMarker.style.top = `${updatedTimelineContainerRect.top}px`;
                renderScheduledEvents(); // Re-render events on timeline to adjust positions
            });

            animateParticles(); // Start particle animation loop
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
�
